var rs=Object.defineProperty;var is=(r,e,n)=>e in r?rs(r,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[e]=n;var Y=(r,e,n)=>(is(r,typeof e!="symbol"?e+"":e,n),n);import{_ as Z}from"./45408441-preload-helper.js";import{E as as,V as F,M as de,T as me,Q as be,S as Bt,a as k,b as Ge,C as os,L as cs,c as ls,F as us,d as xe,R as jt,e as Ut,f as zt,g as et,h as ps,i as R,s as G,j as fs,k as S,G as Nt,B as Vt,P as He,O as tt,l as hs,m as dn,n as ft,o as q,p as ds,D as mn,q as ms,r as gs,t as ys,u as vs,v as ws,A as gn,w as nt,x as ge,U as bs,y as xs,z as yn,H as oe,I as Es,J as Ps,N as Ts,K as As,W as Ms,X as vn,Y as Le,Z as bt,_ as $t,$ as Ls,a0 as Ht,a1 as Ss,a2 as Is,a3 as Cs,a4 as wn,a5 as Ds,a6 as Os,a7 as ks,a8 as Fs,a9 as Rs,aa as _s,ab as Bs,ac as js,ad as Us,ae as zs,af as Ns,ag as Vs,ah as $s,ai as Hs,aj as bn,ak as xn,al as Gt,am as Gs,an as Xs,ao as Ws,ap as Ys}from"./422fb203-three.js";import{C as Ks}from"./e27bbfcf-CopyShader.js";import{ShaderPass as Zs}from"./717175ec-ShaderPass.js";import{P as xt}from"./c51705f5-Pass.js";import{c as ve}from"./042e6b4d-_commonjsHelpers.js";const Xt={type:"change"},st={type:"start"},Wt={type:"end"};class qs extends as{constructor(e,n){super(),this.object=e,this.domElement=n,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new F,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:de.ROTATE,MIDDLE:de.DOLLY,RIGHT:de.PAN},this.touches={ONE:me.ROTATE,TWO:me.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return l.phi},this.getAzimuthalAngle=function(){return l.theta},this.getDistance=function(){return this.object.position.distanceTo(this.target)},this.listenToKeyEvents=function(d){d.addEventListener("keydown",Ot),this._domElementKeyEvents=d},this.saveState=function(){t.target0.copy(t.target),t.position0.copy(t.object.position),t.zoom0=t.object.zoom},this.reset=function(){t.target.copy(t.target0),t.object.position.copy(t.position0),t.object.zoom=t.zoom0,t.object.updateProjectionMatrix(),t.dispatchEvent(Xt),t.update(),i=s.NONE},this.update=function(){const d=new F,E=new be().setFromUnitVectors(e.up,new F(0,1,0)),D=E.clone().invert(),O=new F,W=new be,he=2*Math.PI;return function(){const _t=t.object.position;d.copy(_t).sub(t.target),d.applyQuaternion(E),l.setFromVector3(d),t.autoRotate&&i===s.NONE&&U(_()),t.enableDamping?(l.theta+=a.theta*t.dampingFactor,l.phi+=a.phi*t.dampingFactor):(l.theta+=a.theta,l.phi+=a.phi);let J=t.minAzimuthAngle,ee=t.maxAzimuthAngle;return isFinite(J)&&isFinite(ee)&&(J<-Math.PI?J+=he:J>Math.PI&&(J-=he),ee<-Math.PI?ee+=he:ee>Math.PI&&(ee-=he),J<=ee?l.theta=Math.max(J,Math.min(ee,l.theta)):l.theta=l.theta>(J+ee)/2?Math.max(J,l.theta):Math.min(ee,l.theta)),l.phi=Math.max(t.minPolarAngle,Math.min(t.maxPolarAngle,l.phi)),l.makeSafe(),l.radius*=c,l.radius=Math.max(t.minDistance,Math.min(t.maxDistance,l.radius)),t.enableDamping===!0?t.target.addScaledVector(u,t.dampingFactor):t.target.add(u),d.setFromSpherical(l),d.applyQuaternion(D),_t.copy(t.target).add(d),t.object.lookAt(t.target),t.enableDamping===!0?(a.theta*=1-t.dampingFactor,a.phi*=1-t.dampingFactor,u.multiplyScalar(1-t.dampingFactor)):(a.set(0,0,0),u.set(0,0,0)),c=1,p||O.distanceToSquared(t.object.position)>o||8*(1-W.dot(t.object.quaternion))>o?(t.dispatchEvent(Xt),O.copy(t.object.position),W.copy(t.object.quaternion),p=!1,!0):!1}}(),this.dispose=function(){t.domElement.removeEventListener("contextmenu",kt),t.domElement.removeEventListener("pointerdown",It),t.domElement.removeEventListener("pointercancel",Ct),t.domElement.removeEventListener("wheel",Dt),t.domElement.removeEventListener("pointermove",qe),t.domElement.removeEventListener("pointerup",Qe),t._domElementKeyEvents!==null&&t._domElementKeyEvents.removeEventListener("keydown",Ot)};const t=this,s={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let i=s.NONE;const o=1e-6,l=new Bt,a=new Bt;let c=1;const u=new F;let p=!1;const f=new k,h=new k,m=new k,y=new k,v=new k,w=new k,b=new k,g=new k,P=new k,x=[],A={};function _(){return 2*Math.PI/60/60*t.autoRotateSpeed}function L(){return Math.pow(.95,t.zoomSpeed)}function U(d){a.theta-=d}function C(d){a.phi-=d}const se=function(){const d=new F;return function(D,O){d.setFromMatrixColumn(O,0),d.multiplyScalar(-D),u.add(d)}}(),Q=function(){const d=new F;return function(D,O){t.screenSpacePanning===!0?d.setFromMatrixColumn(O,1):(d.setFromMatrixColumn(O,0),d.crossVectors(t.object.up,d)),d.multiplyScalar(D),u.add(d)}}(),z=function(){const d=new F;return function(D,O){const W=t.domElement;if(t.object.isPerspectiveCamera){const he=t.object.position;d.copy(he).sub(t.target);let Be=d.length();Be*=Math.tan(t.object.fov/2*Math.PI/180),se(2*D*Be/W.clientHeight,t.object.matrix),Q(2*O*Be/W.clientHeight,t.object.matrix)}else t.object.isOrthographicCamera?(se(D*(t.object.right-t.object.left)/t.object.zoom/W.clientWidth,t.object.matrix),Q(O*(t.object.top-t.object.bottom)/t.object.zoom/W.clientHeight,t.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),t.enablePan=!1)}}();function re(d){t.object.isPerspectiveCamera?c/=d:t.object.isOrthographicCamera?(t.object.zoom=Math.max(t.minZoom,Math.min(t.maxZoom,t.object.zoom*d)),t.object.updateProjectionMatrix(),p=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),t.enableZoom=!1)}function Ee(d){t.object.isPerspectiveCamera?c*=d:t.object.isOrthographicCamera?(t.object.zoom=Math.max(t.minZoom,Math.min(t.maxZoom,t.object.zoom/d)),t.object.updateProjectionMatrix(),p=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),t.enableZoom=!1)}function X(d){f.set(d.clientX,d.clientY)}function Ze(d){b.set(d.clientX,d.clientY)}function ke(d){y.set(d.clientX,d.clientY)}function Pe(d){h.set(d.clientX,d.clientY),m.subVectors(h,f).multiplyScalar(t.rotateSpeed);const E=t.domElement;U(2*Math.PI*m.x/E.clientHeight),C(2*Math.PI*m.y/E.clientHeight),f.copy(h),t.update()}function ie(d){g.set(d.clientX,d.clientY),P.subVectors(g,b),P.y>0?re(L()):P.y<0&&Ee(L()),b.copy(g),t.update()}function Fe(d){v.set(d.clientX,d.clientY),w.subVectors(v,y).multiplyScalar(t.panSpeed),z(w.x,w.y),y.copy(v),t.update()}function le(d){d.deltaY<0?Ee(L()):d.deltaY>0&&re(L()),t.update()}function Te(d){let E=!1;switch(d.code){case t.keys.UP:d.ctrlKey||d.metaKey||d.shiftKey?C(2*Math.PI*t.rotateSpeed/t.domElement.clientHeight):z(0,t.keyPanSpeed),E=!0;break;case t.keys.BOTTOM:d.ctrlKey||d.metaKey||d.shiftKey?C(-2*Math.PI*t.rotateSpeed/t.domElement.clientHeight):z(0,-t.keyPanSpeed),E=!0;break;case t.keys.LEFT:d.ctrlKey||d.metaKey||d.shiftKey?U(2*Math.PI*t.rotateSpeed/t.domElement.clientHeight):z(t.keyPanSpeed,0),E=!0;break;case t.keys.RIGHT:d.ctrlKey||d.metaKey||d.shiftKey?U(-2*Math.PI*t.rotateSpeed/t.domElement.clientHeight):z(-t.keyPanSpeed,0),E=!0;break}E&&(d.preventDefault(),t.update())}function fe(){if(x.length===1)f.set(x[0].pageX,x[0].pageY);else{const d=.5*(x[0].pageX+x[1].pageX),E=.5*(x[0].pageY+x[1].pageY);f.set(d,E)}}function Ae(){if(x.length===1)y.set(x[0].pageX,x[0].pageY);else{const d=.5*(x[0].pageX+x[1].pageX),E=.5*(x[0].pageY+x[1].pageY);y.set(d,E)}}function Me(){const d=x[0].pageX-x[1].pageX,E=x[0].pageY-x[1].pageY,D=Math.sqrt(d*d+E*E);b.set(0,D)}function Re(){t.enableZoom&&Me(),t.enablePan&&Ae()}function _e(){t.enableZoom&&Me(),t.enableRotate&&fe()}function Mt(d){if(x.length==1)h.set(d.pageX,d.pageY);else{const D=Je(d),O=.5*(d.pageX+D.x),W=.5*(d.pageY+D.y);h.set(O,W)}m.subVectors(h,f).multiplyScalar(t.rotateSpeed);const E=t.domElement;U(2*Math.PI*m.x/E.clientHeight),C(2*Math.PI*m.y/E.clientHeight),f.copy(h)}function Lt(d){if(x.length===1)v.set(d.pageX,d.pageY);else{const E=Je(d),D=.5*(d.pageX+E.x),O=.5*(d.pageY+E.y);v.set(D,O)}w.subVectors(v,y).multiplyScalar(t.panSpeed),z(w.x,w.y),y.copy(v)}function St(d){const E=Je(d),D=d.pageX-E.x,O=d.pageY-E.y,W=Math.sqrt(D*D+O*O);g.set(0,W),P.set(0,Math.pow(g.y/b.y,t.zoomSpeed)),re(P.y),b.copy(g)}function qn(d){t.enableZoom&&St(d),t.enablePan&&Lt(d)}function Qn(d){t.enableZoom&&St(d),t.enableRotate&&Mt(d)}function It(d){t.enabled!==!1&&(x.length===0&&(t.domElement.setPointerCapture(d.pointerId),t.domElement.addEventListener("pointermove",qe),t.domElement.addEventListener("pointerup",Qe)),ss(d),d.pointerType==="touch"?ts(d):Jn(d))}function qe(d){t.enabled!==!1&&(d.pointerType==="touch"?ns(d):es(d))}function Qe(d){Ft(d),x.length===0&&(t.domElement.releasePointerCapture(d.pointerId),t.domElement.removeEventListener("pointermove",qe),t.domElement.removeEventListener("pointerup",Qe)),t.dispatchEvent(Wt),i=s.NONE}function Ct(d){Ft(d)}function Jn(d){let E;switch(d.button){case 0:E=t.mouseButtons.LEFT;break;case 1:E=t.mouseButtons.MIDDLE;break;case 2:E=t.mouseButtons.RIGHT;break;default:E=-1}switch(E){case de.DOLLY:if(t.enableZoom===!1)return;Ze(d),i=s.DOLLY;break;case de.ROTATE:if(d.ctrlKey||d.metaKey||d.shiftKey){if(t.enablePan===!1)return;ke(d),i=s.PAN}else{if(t.enableRotate===!1)return;X(d),i=s.ROTATE}break;case de.PAN:if(d.ctrlKey||d.metaKey||d.shiftKey){if(t.enableRotate===!1)return;X(d),i=s.ROTATE}else{if(t.enablePan===!1)return;ke(d),i=s.PAN}break;default:i=s.NONE}i!==s.NONE&&t.dispatchEvent(st)}function es(d){switch(i){case s.ROTATE:if(t.enableRotate===!1)return;Pe(d);break;case s.DOLLY:if(t.enableZoom===!1)return;ie(d);break;case s.PAN:if(t.enablePan===!1)return;Fe(d);break}}function Dt(d){t.enabled===!1||t.enableZoom===!1||i!==s.NONE||(d.preventDefault(),t.dispatchEvent(st),le(d),t.dispatchEvent(Wt))}function Ot(d){t.enabled===!1||t.enablePan===!1||Te(d)}function ts(d){switch(Rt(d),x.length){case 1:switch(t.touches.ONE){case me.ROTATE:if(t.enableRotate===!1)return;fe(),i=s.TOUCH_ROTATE;break;case me.PAN:if(t.enablePan===!1)return;Ae(),i=s.TOUCH_PAN;break;default:i=s.NONE}break;case 2:switch(t.touches.TWO){case me.DOLLY_PAN:if(t.enableZoom===!1&&t.enablePan===!1)return;Re(),i=s.TOUCH_DOLLY_PAN;break;case me.DOLLY_ROTATE:if(t.enableZoom===!1&&t.enableRotate===!1)return;_e(),i=s.TOUCH_DOLLY_ROTATE;break;default:i=s.NONE}break;default:i=s.NONE}i!==s.NONE&&t.dispatchEvent(st)}function ns(d){switch(Rt(d),i){case s.TOUCH_ROTATE:if(t.enableRotate===!1)return;Mt(d),t.update();break;case s.TOUCH_PAN:if(t.enablePan===!1)return;Lt(d),t.update();break;case s.TOUCH_DOLLY_PAN:if(t.enableZoom===!1&&t.enablePan===!1)return;qn(d),t.update();break;case s.TOUCH_DOLLY_ROTATE:if(t.enableZoom===!1&&t.enableRotate===!1)return;Qn(d),t.update();break;default:i=s.NONE}}function kt(d){t.enabled!==!1&&d.preventDefault()}function ss(d){x.push(d)}function Ft(d){delete A[d.pointerId];for(let E=0;E<x.length;E++)if(x[E].pointerId==d.pointerId){x.splice(E,1);return}}function Rt(d){let E=A[d.pointerId];E===void 0&&(E=new k,A[d.pointerId]=E),E.set(d.pageX,d.pageY)}function Je(d){const E=d.pointerId===x[0].pointerId?x[1]:x[0];return A[E.pointerId]}t.domElement.addEventListener("contextmenu",kt),t.domElement.addEventListener("pointerdown",It),t.domElement.addEventListener("pointercancel",Ct),t.domElement.addEventListener("wheel",Dt,{passive:!1}),this.update()}}const En="fbx",Pn="animations",Qs="img/textures/matcap",Xe="data";/*!
fflate - fast JavaScript compression/decompression
<https://101arrowz.github.io/fflate>
Licensed under MIT. https://github.com/101arrowz/fflate/blob/master/LICENSE
version 0.6.9
*/var Yt=function(r){return URL.createObjectURL(new Blob([r],{type:"text/javascript"}))};try{URL.revokeObjectURL(Yt(""))}catch{Yt=function(e){return"data:application/javascript;charset=UTF-8,"+encodeURI(e)}}var H=Uint8Array,ce=Uint16Array,ht=Uint32Array,Tn=new H([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),An=new H([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Js=new H([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Mn=function(r,e){for(var n=new ce(31),t=0;t<31;++t)n[t]=e+=1<<r[t-1];for(var s=new ht(n[30]),t=1;t<30;++t)for(var i=n[t];i<n[t+1];++i)s[i]=i-n[t]<<5|t;return[n,s]},Ln=Mn(Tn,2),Sn=Ln[0],er=Ln[1];Sn[28]=258,er[258]=28;var tr=Mn(An,0),nr=tr[0],dt=new ce(32768);for(var M=0;M<32768;++M){var ae=(M&43690)>>>1|(M&21845)<<1;ae=(ae&52428)>>>2|(ae&13107)<<2,ae=(ae&61680)>>>4|(ae&3855)<<4,dt[M]=((ae&65280)>>>8|(ae&255)<<8)>>>1}var Se=function(r,e,n){for(var t=r.length,s=0,i=new ce(e);s<t;++s)++i[r[s]-1];var o=new ce(e);for(s=0;s<e;++s)o[s]=o[s-1]+i[s-1]<<1;var l;if(n){l=new ce(1<<e);var a=15-e;for(s=0;s<t;++s)if(r[s])for(var c=s<<4|r[s],u=e-r[s],p=o[r[s]-1]++<<u,f=p|(1<<u)-1;p<=f;++p)l[dt[p]>>>a]=c}else for(l=new ce(t),s=0;s<t;++s)r[s]&&(l[s]=dt[o[r[s]-1]++]>>>15-r[s]);return l},De=new H(288);for(var M=0;M<144;++M)De[M]=8;for(var M=144;M<256;++M)De[M]=9;for(var M=256;M<280;++M)De[M]=7;for(var M=280;M<288;++M)De[M]=8;var In=new H(32);for(var M=0;M<32;++M)In[M]=5;var sr=Se(De,9,1),rr=Se(In,5,1),rt=function(r){for(var e=r[0],n=1;n<r.length;++n)r[n]>e&&(e=r[n]);return e},K=function(r,e,n){var t=e/8|0;return(r[t]|r[t+1]<<8)>>(e&7)&n},it=function(r,e){var n=e/8|0;return(r[n]|r[n+1]<<8|r[n+2]<<16)>>(e&7)},ir=function(r){return(r/8|0)+(r&7&&1)},ar=function(r,e,n){(e==null||e<0)&&(e=0),(n==null||n>r.length)&&(n=r.length);var t=new(r instanceof ce?ce:r instanceof ht?ht:H)(n-e);return t.set(r.subarray(e,n)),t},or=function(r,e,n){var t=r.length;if(!t||n&&!n.l&&t<5)return e||new H(0);var s=!e||n,i=!n||n.i;n||(n={}),e||(e=new H(t*3));var o=function(Me){var Re=e.length;if(Me>Re){var _e=new H(Math.max(Re*2,Me));_e.set(e),e=_e}},l=n.f||0,a=n.p||0,c=n.b||0,u=n.l,p=n.d,f=n.m,h=n.n,m=t*8;do{if(!u){n.f=l=K(r,a,1);var y=K(r,a+1,3);if(a+=3,y)if(y==1)u=sr,p=rr,f=9,h=5;else if(y==2){var g=K(r,a,31)+257,P=K(r,a+10,15)+4,x=g+K(r,a+5,31)+1;a+=14;for(var A=new H(x),_=new H(19),L=0;L<P;++L)_[Js[L]]=K(r,a+L*3,7);a+=P*3;for(var U=rt(_),C=(1<<U)-1,se=Se(_,U,1),L=0;L<x;){var Q=se[K(r,a,C)];a+=Q&15;var v=Q>>>4;if(v<16)A[L++]=v;else{var z=0,re=0;for(v==16?(re=3+K(r,a,3),a+=2,z=A[L-1]):v==17?(re=3+K(r,a,7),a+=3):v==18&&(re=11+K(r,a,127),a+=7);re--;)A[L++]=z}}var Ee=A.subarray(0,g),X=A.subarray(g);f=rt(Ee),h=rt(X),u=Se(Ee,f,1),p=Se(X,h,1)}else throw"invalid block type";else{var v=ir(a)+4,w=r[v-4]|r[v-3]<<8,b=v+w;if(b>t){if(i)throw"unexpected EOF";break}s&&o(c+w),e.set(r.subarray(v,b),c),n.b=c+=w,n.p=a=b*8;continue}if(a>m){if(i)throw"unexpected EOF";break}}s&&o(c+131072);for(var Ze=(1<<f)-1,ke=(1<<h)-1,Pe=a;;Pe=a){var z=u[it(r,a)&Ze],ie=z>>>4;if(a+=z&15,a>m){if(i)throw"unexpected EOF";break}if(!z)throw"invalid length/literal";if(ie<256)e[c++]=ie;else if(ie==256){Pe=a,u=null;break}else{var Fe=ie-254;if(ie>264){var L=ie-257,le=Tn[L];Fe=K(r,a,(1<<le)-1)+Sn[L],a+=le}var Te=p[it(r,a)&ke],fe=Te>>>4;if(!Te)throw"invalid distance";a+=Te&15;var X=nr[fe];if(fe>3){var le=An[fe];X+=it(r,a)&(1<<le)-1,a+=le}if(a>m){if(i)throw"unexpected EOF";break}s&&o(c+131072);for(var Ae=c+Fe;c<Ae;c+=4)e[c]=e[c-X],e[c+1]=e[c+1-X],e[c+2]=e[c+2-X],e[c+3]=e[c+3-X];c=Ae}}n.l=u,n.p=Pe,n.b=c,u&&(l=1,n.m=f,n.d=p,n.n=h)}while(!l);return c==e.length?e:ar(e,0,c)},cr=new H(0),lr=function(r){if((r[0]&15)!=8||r[0]>>>4>7||(r[0]<<8|r[1])%31)throw"invalid zlib data";if(r[1]&32)throw"invalid zlib data: preset dictionaries not supported"};function ur(r,e){return or((lr(r),r.subarray(2,-4)),e)}var pr=typeof TextDecoder<"u"&&new TextDecoder,fr=0;try{pr.decode(cr,{stream:!0}),fr=1}catch{}function Cn(r,e,n){const t=n.length-r-1;if(e>=n[t])return t-1;if(e<=n[r])return r;let s=r,i=t,o=Math.floor((s+i)/2);for(;e<n[o]||e>=n[o+1];)e<n[o]?i=o:s=o,o=Math.floor((s+i)/2);return o}function hr(r,e,n,t){const s=[],i=[],o=[];s[0]=1;for(let l=1;l<=n;++l){i[l]=e-t[r+1-l],o[l]=t[r+l]-e;let a=0;for(let c=0;c<l;++c){const u=o[c+1],p=i[l-c],f=s[c]/(u+p);s[c]=a+u*f,a=p*f}s[l]=a}return s}function dr(r,e,n,t){const s=Cn(r,t,e),i=hr(s,t,r,e),o=new Ge(0,0,0,0);for(let l=0;l<=r;++l){const a=n[s-r+l],c=i[l],u=a.w*c;o.x+=a.x*u,o.y+=a.y*u,o.z+=a.z*u,o.w+=a.w*c}return o}function mr(r,e,n,t,s){const i=[];for(let p=0;p<=n;++p)i[p]=0;const o=[];for(let p=0;p<=t;++p)o[p]=i.slice(0);const l=[];for(let p=0;p<=n;++p)l[p]=i.slice(0);l[0][0]=1;const a=i.slice(0),c=i.slice(0);for(let p=1;p<=n;++p){a[p]=e-s[r+1-p],c[p]=s[r+p]-e;let f=0;for(let h=0;h<p;++h){const m=c[h+1],y=a[p-h];l[p][h]=m+y;const v=l[h][p-1]/l[p][h];l[h][p]=f+m*v,f=y*v}l[p][p]=f}for(let p=0;p<=n;++p)o[0][p]=l[p][n];for(let p=0;p<=n;++p){let f=0,h=1;const m=[];for(let y=0;y<=n;++y)m[y]=i.slice(0);m[0][0]=1;for(let y=1;y<=t;++y){let v=0;const w=p-y,b=n-y;p>=y&&(m[h][0]=m[f][0]/l[b+1][w],v=m[h][0]*l[w][b]);const g=w>=-1?1:-w,P=p-1<=b?y-1:n-p;for(let A=g;A<=P;++A)m[h][A]=(m[f][A]-m[f][A-1])/l[b+1][w+A],v+=m[h][A]*l[w+A][b];p<=b&&(m[h][y]=-m[f][y-1]/l[b+1][p],v+=m[h][y]*l[p][b]),o[y][p]=v;const x=f;f=h,h=x}}let u=n;for(let p=1;p<=t;++p){for(let f=0;f<=n;++f)o[p][f]*=u;u*=n-p}return o}function gr(r,e,n,t,s){const i=s<r?s:r,o=[],l=Cn(r,t,e),a=mr(l,t,r,i,e),c=[];for(let u=0;u<n.length;++u){const p=n[u].clone(),f=p.w;p.x*=f,p.y*=f,p.z*=f,c[u]=p}for(let u=0;u<=i;++u){const p=c[l-r].clone().multiplyScalar(a[u][0]);for(let f=1;f<=r;++f)p.add(c[l-r+f].clone().multiplyScalar(a[u][f]));o[u]=p}for(let u=i+1;u<=s+1;++u)o[u]=new Ge(0,0,0);return o}function yr(r,e){let n=1;for(let s=2;s<=r;++s)n*=s;let t=1;for(let s=2;s<=e;++s)t*=s;for(let s=2;s<=r-e;++s)t*=s;return n/t}function vr(r){const e=r.length,n=[],t=[];for(let i=0;i<e;++i){const o=r[i];n[i]=new F(o.x,o.y,o.z),t[i]=o.w}const s=[];for(let i=0;i<e;++i){const o=n[i].clone();for(let l=1;l<=i;++l)o.sub(s[i-l].clone().multiplyScalar(yr(i,l)*t[l]));s[i]=o.divideScalar(t[0])}return s}function wr(r,e,n,t,s){const i=gr(r,e,n,t,s);return vr(i)}class br extends os{constructor(e,n,t,s,i){super(),this.degree=e,this.knots=n,this.controlPoints=[],this.startKnot=s||0,this.endKnot=i||this.knots.length-1;for(let o=0;o<t.length;++o){const l=t[o];this.controlPoints[o]=new Ge(l.x,l.y,l.z,l.w)}}getPoint(e,n=new F){const t=n,s=this.knots[this.startKnot]+e*(this.knots[this.endKnot]-this.knots[this.startKnot]),i=dr(this.degree,this.knots,this.controlPoints,s);return i.w!==1&&i.divideScalar(i.w),t.set(i.x,i.y,i.z)}getTangent(e,n=new F){const t=n,s=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),i=wr(this.degree,this.knots,this.controlPoints,s,1);return t.copy(i[1]).normalize(),t}}let T,I,B;class xr extends cs{constructor(e){super(e)}load(e,n,t,s){const i=this,o=i.path===""?ls.extractUrlBase(e):i.path,l=new us(this.manager);l.setPath(i.path),l.setResponseType("arraybuffer"),l.setRequestHeader(i.requestHeader),l.setWithCredentials(i.withCredentials),l.load(e,function(a){try{n(i.parse(a,o))}catch(c){s?s(c):console.error(c),i.manager.itemError(e)}},t,s)}parse(e,n){if(Lr(e))T=new Mr().parse(e);else{const s=Fn(e);if(!Sr(s))throw new Error("THREE.FBXLoader: Unknown format.");if(Zt(s)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+Zt(s));T=new Ar().parse(s)}const t=new xe(this.manager).setPath(this.resourcePath||n).setCrossOrigin(this.crossOrigin);return new Er(t,this.manager).parse(T)}}class Er{constructor(e,n){this.textureLoader=e,this.manager=n}parse(){I=this.parseConnections();const e=this.parseImages(),n=this.parseTextures(e),t=this.parseMaterials(n),s=this.parseDeformers(),i=new Pr().parse(s);return this.parseScene(s,i,t),B}parseConnections(){const e=new Map;return"Connections"in T&&T.Connections.connections.forEach(function(t){const s=t[0],i=t[1],o=t[2];e.has(s)||e.set(s,{parents:[],children:[]});const l={ID:i,relationship:o};e.get(s).parents.push(l),e.has(i)||e.set(i,{parents:[],children:[]});const a={ID:s,relationship:o};e.get(i).children.push(a)}),e}parseImages(){const e={},n={};if("Video"in T.Objects){const t=T.Objects.Video;for(const s in t){const i=t[s],o=parseInt(s);if(e[o]=i.RelativeFilename||i.Filename,"Content"in i){const l=i.Content instanceof ArrayBuffer&&i.Content.byteLength>0,a=typeof i.Content=="string"&&i.Content!=="";if(l||a){const c=this.parseImage(t[s]);n[i.RelativeFilename||i.Filename]=c}}}}for(const t in e){const s=e[t];n[s]!==void 0?e[t]=n[s]:e[t]=e[t].split("\\").pop()}return e}parseImage(e){const n=e.Content,t=e.RelativeFilename||e.Filename,s=t.slice(t.lastIndexOf(".")+1).toLowerCase();let i;switch(s){case"bmp":i="image/bmp";break;case"jpg":case"jpeg":i="image/jpeg";break;case"png":i="image/png";break;case"tif":i="image/tiff";break;case"tga":this.manager.getHandler(".tga")===null&&console.warn("FBXLoader: TGA loader not found, skipping ",t),i="image/tga";break;default:console.warn('FBXLoader: Image type "'+s+'" is not supported.');return}if(typeof n=="string")return"data:"+i+";base64,"+n;{const o=new Uint8Array(n);return window.URL.createObjectURL(new Blob([o],{type:i}))}}parseTextures(e){const n=new Map;if("Texture"in T.Objects){const t=T.Objects.Texture;for(const s in t){const i=this.parseTexture(t[s],e);n.set(parseInt(s),i)}}return n}parseTexture(e,n){const t=this.loadTexture(e,n);t.ID=e.id,t.name=e.attrName;const s=e.WrapModeU,i=e.WrapModeV,o=s!==void 0?s.value:0,l=i!==void 0?i.value:0;if(t.wrapS=o===0?jt:Ut,t.wrapT=l===0?jt:Ut,"Scaling"in e){const a=e.Scaling.value;t.repeat.x=a[0],t.repeat.y=a[1]}if("Translation"in e){const a=e.Translation.value;t.offset.x=a[0],t.offset.y=a[1]}return t}loadTexture(e,n){let t;const s=this.textureLoader.path,i=I.get(e.id).children;i!==void 0&&i.length>0&&n[i[0].ID]!==void 0&&(t=n[i[0].ID],(t.indexOf("blob:")===0||t.indexOf("data:")===0)&&this.textureLoader.setPath(void 0));let o;const l=e.FileName.slice(-3).toLowerCase();if(l==="tga"){const a=this.manager.getHandler(".tga");a===null?(console.warn("FBXLoader: TGA loader not found, creating placeholder texture for",e.RelativeFilename),o=new zt):(a.setPath(this.textureLoader.path),o=a.load(t))}else l==="psd"?(console.warn("FBXLoader: PSD textures are not supported, creating placeholder texture for",e.RelativeFilename),o=new zt):o=this.textureLoader.load(t);return this.textureLoader.setPath(s),o}parseMaterials(e){const n=new Map;if("Material"in T.Objects){const t=T.Objects.Material;for(const s in t){const i=this.parseMaterial(t[s],e);i!==null&&n.set(parseInt(s),i)}}return n}parseMaterial(e,n){const t=e.id,s=e.attrName;let i=e.ShadingModel;if(typeof i=="object"&&(i=i.value),!I.has(t))return null;const o=this.parseParameters(e,n,t);let l;switch(i.toLowerCase()){case"phong":l=new et;break;case"lambert":l=new ps;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',i),l=new et;break}return l.setValues(o),l.name=s,l}parseParameters(e,n,t){const s={};e.BumpFactor&&(s.bumpScale=e.BumpFactor.value),e.Diffuse?s.color=new R().fromArray(e.Diffuse.value):e.DiffuseColor&&(e.DiffuseColor.type==="Color"||e.DiffuseColor.type==="ColorRGB")&&(s.color=new R().fromArray(e.DiffuseColor.value)),e.DisplacementFactor&&(s.displacementScale=e.DisplacementFactor.value),e.Emissive?s.emissive=new R().fromArray(e.Emissive.value):e.EmissiveColor&&(e.EmissiveColor.type==="Color"||e.EmissiveColor.type==="ColorRGB")&&(s.emissive=new R().fromArray(e.EmissiveColor.value)),e.EmissiveFactor&&(s.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(s.opacity=parseFloat(e.Opacity.value)),s.opacity<1&&(s.transparent=!0),e.ReflectionFactor&&(s.reflectivity=e.ReflectionFactor.value),e.Shininess&&(s.shininess=e.Shininess.value),e.Specular?s.specular=new R().fromArray(e.Specular.value):e.SpecularColor&&e.SpecularColor.type==="Color"&&(s.specular=new R().fromArray(e.SpecularColor.value));const i=this;return I.get(t).children.forEach(function(o){const l=o.relationship;switch(l){case"Bump":s.bumpMap=i.getTexture(n,o.ID);break;case"Maya|TEX_ao_map":s.aoMap=i.getTexture(n,o.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":s.map=i.getTexture(n,o.ID),s.map!==void 0&&(s.map.encoding=G);break;case"DisplacementColor":s.displacementMap=i.getTexture(n,o.ID);break;case"EmissiveColor":s.emissiveMap=i.getTexture(n,o.ID),s.emissiveMap!==void 0&&(s.emissiveMap.encoding=G);break;case"NormalMap":case"Maya|TEX_normal_map":s.normalMap=i.getTexture(n,o.ID);break;case"ReflectionColor":s.envMap=i.getTexture(n,o.ID),s.envMap!==void 0&&(s.envMap.mapping=fs,s.envMap.encoding=G);break;case"SpecularColor":s.specularMap=i.getTexture(n,o.ID),s.specularMap!==void 0&&(s.specularMap.encoding=G);break;case"TransparentColor":case"TransparencyFactor":s.alphaMap=i.getTexture(n,o.ID),s.transparent=!0;break;case"AmbientColor":case"ShininessExponent":case"SpecularFactor":case"VectorDisplacementColor":default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",l);break}}),s}getTexture(e,n){return"LayeredTexture"in T.Objects&&n in T.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),n=I.get(n).children[0].ID),e.get(n)}parseDeformers(){const e={},n={};if("Deformer"in T.Objects){const t=T.Objects.Deformer;for(const s in t){const i=t[s],o=I.get(parseInt(s));if(i.attrType==="Skin"){const l=this.parseSkeleton(o,t);l.ID=s,o.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),l.geometryID=o.parents[0].ID,e[s]=l}else if(i.attrType==="BlendShape"){const l={id:s};l.rawTargets=this.parseMorphTargets(o,t),l.id=s,o.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),n[s]=l}}}return{skeletons:e,morphTargets:n}}parseSkeleton(e,n){const t=[];return e.children.forEach(function(s){const i=n[s.ID];if(i.attrType!=="Cluster")return;const o={ID:s.ID,indices:[],weights:[],transformLink:new S().fromArray(i.TransformLink.a)};"Indexes"in i&&(o.indices=i.Indexes.a,o.weights=i.Weights.a),t.push(o)}),{rawBones:t,bones:[]}}parseMorphTargets(e,n){const t=[];for(let s=0;s<e.children.length;s++){const i=e.children[s],o=n[i.ID],l={name:o.attrName,initialWeight:o.DeformPercent,id:o.id,fullWeights:o.FullWeights.a};if(o.attrType!=="BlendShapeChannel")return;l.geoID=I.get(parseInt(i.ID)).children.filter(function(a){return a.relationship===void 0})[0].ID,t.push(l)}return t}parseScene(e,n,t){B=new Nt;const s=this.parseModels(e.skeletons,n,t),i=T.Objects.Model,o=this;s.forEach(function(a){const c=i[a.ID];o.setLookAtProperties(a,c),I.get(a.ID).parents.forEach(function(p){const f=s.get(p.ID);f!==void 0&&f.add(a)}),a.parent===null&&B.add(a)}),this.bindSkeleton(e.skeletons,n,s),this.createAmbientLight(),B.traverse(function(a){if(a.userData.transformData){a.parent&&(a.userData.transformData.parentMatrix=a.parent.matrix,a.userData.transformData.parentMatrixWorld=a.parent.matrixWorld);const c=On(a.userData.transformData);a.applyMatrix4(c),a.updateWorldMatrix()}});const l=new Tr().parse();B.children.length===1&&B.children[0].isGroup&&(B.children[0].animations=l,B=B.children[0]),B.animations=l}parseModels(e,n,t){const s=new Map,i=T.Objects.Model;for(const o in i){const l=parseInt(o),a=i[o],c=I.get(l);let u=this.buildSkeleton(c,e,l,a.attrName);if(!u){switch(a.attrType){case"Camera":u=this.createCamera(c);break;case"Light":u=this.createLight(c);break;case"Mesh":u=this.createMesh(c,n,t);break;case"NurbsCurve":u=this.createCurve(c,n);break;case"LimbNode":case"Root":u=new Vt;break;case"Null":default:u=new Nt;break}u.name=a.attrName?He.sanitizeNodeName(a.attrName):"",u.ID=l}this.getTransformData(u,a),s.set(l,u)}return s}buildSkeleton(e,n,t,s){let i=null;return e.parents.forEach(function(o){for(const l in n){const a=n[l];a.rawBones.forEach(function(c,u){if(c.ID===o.ID){const p=i;i=new Vt,i.matrixWorld.copy(c.transformLink),i.name=s?He.sanitizeNodeName(s):"",i.ID=t,a.bones[u]=i,p!==null&&i.add(p)}})}}),i}createCamera(e){let n,t;if(e.children.forEach(function(s){const i=T.Objects.NodeAttribute[s.ID];i!==void 0&&(t=i)}),t===void 0)n=new tt;else{let s=0;t.CameraProjectionType!==void 0&&t.CameraProjectionType.value===1&&(s=1);let i=1;t.NearPlane!==void 0&&(i=t.NearPlane.value/1e3);let o=1e3;t.FarPlane!==void 0&&(o=t.FarPlane.value/1e3);let l=window.innerWidth,a=window.innerHeight;t.AspectWidth!==void 0&&t.AspectHeight!==void 0&&(l=t.AspectWidth.value,a=t.AspectHeight.value);const c=l/a;let u=45;t.FieldOfView!==void 0&&(u=t.FieldOfView.value);const p=t.FocalLength?t.FocalLength.value:null;switch(s){case 0:n=new dn(u,c,i,o),p!==null&&n.setFocalLength(p);break;case 1:n=new hs(-l/2,l/2,a/2,-a/2,i,o);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+s+"."),n=new tt;break}}return n}createLight(e){let n,t;if(e.children.forEach(function(s){const i=T.Objects.NodeAttribute[s.ID];i!==void 0&&(t=i)}),t===void 0)n=new tt;else{let s;t.LightType===void 0?s=0:s=t.LightType.value;let i=16777215;t.Color!==void 0&&(i=new R().fromArray(t.Color.value));let o=t.Intensity===void 0?1:t.Intensity.value/100;t.CastLightOnObject!==void 0&&t.CastLightOnObject.value===0&&(o=0);let l=0;t.FarAttenuationEnd!==void 0&&(t.EnableFarAttenuation!==void 0&&t.EnableFarAttenuation.value===0?l=0:l=t.FarAttenuationEnd.value);const a=1;switch(s){case 0:n=new ft(i,o,l,a);break;case 1:n=new mn(i,o);break;case 2:let c=Math.PI/3;t.InnerAngle!==void 0&&(c=q.degToRad(t.InnerAngle.value));let u=0;t.OuterAngle!==void 0&&(u=q.degToRad(t.OuterAngle.value),u=Math.max(u,1)),n=new ds(i,o,l,c,u,a);break;default:console.warn("THREE.FBXLoader: Unknown light type "+t.LightType.value+", defaulting to a PointLight."),n=new ft(i,o);break}t.CastShadows!==void 0&&t.CastShadows.value===1&&(n.castShadow=!0)}return n}createMesh(e,n,t){let s,i=null,o=null;const l=[];return e.children.forEach(function(a){n.has(a.ID)&&(i=n.get(a.ID)),t.has(a.ID)&&l.push(t.get(a.ID))}),l.length>1?o=l:l.length>0?o=l[0]:(o=new et({color:13421772}),l.push(o)),"color"in i.attributes&&l.forEach(function(a){a.vertexColors=!0}),i.FBX_Deformer?(s=new ms(i,o),s.normalizeSkinWeights()):s=new gs(i,o),s}createCurve(e,n){const t=e.children.reduce(function(i,o){return n.has(o.ID)&&(i=n.get(o.ID)),i},null),s=new ys({color:3342591,linewidth:1});return new vs(t,s)}getTransformData(e,n){const t={};"InheritType"in n&&(t.inheritType=parseInt(n.InheritType.value)),"RotationOrder"in n?t.eulerOrder=kn(n.RotationOrder.value):t.eulerOrder="ZYX","Lcl_Translation"in n&&(t.translation=n.Lcl_Translation.value),"PreRotation"in n&&(t.preRotation=n.PreRotation.value),"Lcl_Rotation"in n&&(t.rotation=n.Lcl_Rotation.value),"PostRotation"in n&&(t.postRotation=n.PostRotation.value),"Lcl_Scaling"in n&&(t.scale=n.Lcl_Scaling.value),"ScalingOffset"in n&&(t.scalingOffset=n.ScalingOffset.value),"ScalingPivot"in n&&(t.scalingPivot=n.ScalingPivot.value),"RotationOffset"in n&&(t.rotationOffset=n.RotationOffset.value),"RotationPivot"in n&&(t.rotationPivot=n.RotationPivot.value),e.userData.transformData=t}setLookAtProperties(e,n){"LookAtProperty"in n&&I.get(e.ID).children.forEach(function(s){if(s.relationship==="LookAtProperty"){const i=T.Objects.Model[s.ID];if("Lcl_Translation"in i){const o=i.Lcl_Translation.value;e.target!==void 0?(e.target.position.fromArray(o),B.add(e.target)):e.lookAt(new F().fromArray(o))}}})}bindSkeleton(e,n,t){const s=this.parsePoseNodes();for(const i in e){const o=e[i];I.get(parseInt(o.ID)).parents.forEach(function(a){if(n.has(a.ID)){const c=a.ID;I.get(c).parents.forEach(function(p){t.has(p.ID)&&t.get(p.ID).bind(new ws(o.bones),s[p.ID])})}})}}parsePoseNodes(){const e={};if("Pose"in T.Objects){const n=T.Objects.Pose;for(const t in n)if(n[t].attrType==="BindPose"&&n[t].NbPoseNodes>0){const s=n[t].PoseNode;Array.isArray(s)?s.forEach(function(i){e[i.Node]=new S().fromArray(i.Matrix.a)}):e[s.Node]=new S().fromArray(s.Matrix.a)}}return e}createAmbientLight(){if("GlobalSettings"in T&&"AmbientColor"in T.GlobalSettings){const e=T.GlobalSettings.AmbientColor.value,n=e[0],t=e[1],s=e[2];if(n!==0||t!==0||s!==0){const i=new R(n,t,s);B.add(new gn(i,1))}}}}class Pr{constructor(){this.negativeMaterialIndices=!1}parse(e){const n=new Map;if("Geometry"in T.Objects){const t=T.Objects.Geometry;for(const s in t){const i=I.get(parseInt(s)),o=this.parseGeometry(i,t[s],e);n.set(parseInt(s),o)}}return this.negativeMaterialIndices===!0&&console.warn("THREE.FBXLoader: The FBX file contains invalid (negative) material indices. The asset might not render as expected."),n}parseGeometry(e,n,t){switch(n.attrType){case"Mesh":return this.parseMeshGeometry(e,n,t);case"NurbsCurve":return this.parseNurbsGeometry(n)}}parseMeshGeometry(e,n,t){const s=t.skeletons,i=[],o=e.parents.map(function(p){return T.Objects.Model[p.ID]});if(o.length===0)return;const l=e.children.reduce(function(p,f){return s[f.ID]!==void 0&&(p=s[f.ID]),p},null);e.children.forEach(function(p){t.morphTargets[p.ID]!==void 0&&i.push(t.morphTargets[p.ID])});const a=o[0],c={};"RotationOrder"in a&&(c.eulerOrder=kn(a.RotationOrder.value)),"InheritType"in a&&(c.inheritType=parseInt(a.InheritType.value)),"GeometricTranslation"in a&&(c.translation=a.GeometricTranslation.value),"GeometricRotation"in a&&(c.rotation=a.GeometricRotation.value),"GeometricScaling"in a&&(c.scale=a.GeometricScaling.value);const u=On(c);return this.genGeometry(n,l,i,u)}genGeometry(e,n,t,s){const i=new nt;e.attrName&&(i.name=e.attrName);const o=this.parseGeoNode(e,n),l=this.genBuffers(o),a=new ge(l.vertex,3);if(a.applyMatrix4(s),i.setAttribute("position",a),l.colors.length>0&&i.setAttribute("color",new ge(l.colors,3)),n&&(i.setAttribute("skinIndex",new bs(l.weightsIndices,4)),i.setAttribute("skinWeight",new ge(l.vertexWeights,4)),i.FBX_Deformer=n),l.normal.length>0){const c=new xs().getNormalMatrix(s),u=new ge(l.normal,3);u.applyNormalMatrix(c),i.setAttribute("normal",u)}if(l.uvs.forEach(function(c,u){let p="uv"+(u+1).toString();u===0&&(p="uv"),i.setAttribute(p,new ge(l.uvs[u],2))}),o.material&&o.material.mappingType!=="AllSame"){let c=l.materialIndex[0],u=0;if(l.materialIndex.forEach(function(p,f){p!==c&&(i.addGroup(u,f-u,c),c=p,u=f)}),i.groups.length>0){const p=i.groups[i.groups.length-1],f=p.start+p.count;f!==l.materialIndex.length&&i.addGroup(f,l.materialIndex.length-f,c)}i.groups.length===0&&i.addGroup(0,l.materialIndex.length,l.materialIndex[0])}return this.addMorphTargets(i,e,t,s),i}parseGeoNode(e,n){const t={};if(t.vertexPositions=e.Vertices!==void 0?e.Vertices.a:[],t.vertexIndices=e.PolygonVertexIndex!==void 0?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(t.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(t.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(t.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){t.uv=[];let s=0;for(;e.LayerElementUV[s];)e.LayerElementUV[s].UV&&t.uv.push(this.parseUVs(e.LayerElementUV[s])),s++}return t.weightTable={},n!==null&&(t.skeleton=n,n.rawBones.forEach(function(s,i){s.indices.forEach(function(o,l){t.weightTable[o]===void 0&&(t.weightTable[o]=[]),t.weightTable[o].push({id:i,weight:s.weights[l]})})})),t}genBuffers(e){const n={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let t=0,s=0,i=!1,o=[],l=[],a=[],c=[],u=[],p=[];const f=this;return e.vertexIndices.forEach(function(h,m){let y,v=!1;h<0&&(h=h^-1,v=!0);let w=[],b=[];if(o.push(h*3,h*3+1,h*3+2),e.color){const g=je(m,t,h,e.color);a.push(g[0],g[1],g[2])}if(e.skeleton){if(e.weightTable[h]!==void 0&&e.weightTable[h].forEach(function(g){b.push(g.weight),w.push(g.id)}),b.length>4){i||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),i=!0);const g=[0,0,0,0],P=[0,0,0,0];b.forEach(function(x,A){let _=x,L=w[A];P.forEach(function(U,C,se){if(_>U){se[C]=_,_=U;const Q=g[C];g[C]=L,L=Q}})}),w=g,b=P}for(;b.length<4;)b.push(0),w.push(0);for(let g=0;g<4;++g)u.push(b[g]),p.push(w[g])}if(e.normal){const g=je(m,t,h,e.normal);l.push(g[0],g[1],g[2])}e.material&&e.material.mappingType!=="AllSame"&&(y=je(m,t,h,e.material)[0],y<0&&(f.negativeMaterialIndices=!0,y=0)),e.uv&&e.uv.forEach(function(g,P){const x=je(m,t,h,g);c[P]===void 0&&(c[P]=[]),c[P].push(x[0]),c[P].push(x[1])}),s++,v&&(s>4&&console.warn("THREE.FBXLoader: Polygons with more than four sides are not supported. Make sure to triangulate the geometry during export."),f.genFace(n,e,o,y,l,a,c,u,p,s),t++,s=0,o=[],l=[],a=[],c=[],u=[],p=[])}),n}genFace(e,n,t,s,i,o,l,a,c,u){for(let p=2;p<u;p++)e.vertex.push(n.vertexPositions[t[0]]),e.vertex.push(n.vertexPositions[t[1]]),e.vertex.push(n.vertexPositions[t[2]]),e.vertex.push(n.vertexPositions[t[(p-1)*3]]),e.vertex.push(n.vertexPositions[t[(p-1)*3+1]]),e.vertex.push(n.vertexPositions[t[(p-1)*3+2]]),e.vertex.push(n.vertexPositions[t[p*3]]),e.vertex.push(n.vertexPositions[t[p*3+1]]),e.vertex.push(n.vertexPositions[t[p*3+2]]),n.skeleton&&(e.vertexWeights.push(a[0]),e.vertexWeights.push(a[1]),e.vertexWeights.push(a[2]),e.vertexWeights.push(a[3]),e.vertexWeights.push(a[(p-1)*4]),e.vertexWeights.push(a[(p-1)*4+1]),e.vertexWeights.push(a[(p-1)*4+2]),e.vertexWeights.push(a[(p-1)*4+3]),e.vertexWeights.push(a[p*4]),e.vertexWeights.push(a[p*4+1]),e.vertexWeights.push(a[p*4+2]),e.vertexWeights.push(a[p*4+3]),e.weightsIndices.push(c[0]),e.weightsIndices.push(c[1]),e.weightsIndices.push(c[2]),e.weightsIndices.push(c[3]),e.weightsIndices.push(c[(p-1)*4]),e.weightsIndices.push(c[(p-1)*4+1]),e.weightsIndices.push(c[(p-1)*4+2]),e.weightsIndices.push(c[(p-1)*4+3]),e.weightsIndices.push(c[p*4]),e.weightsIndices.push(c[p*4+1]),e.weightsIndices.push(c[p*4+2]),e.weightsIndices.push(c[p*4+3])),n.color&&(e.colors.push(o[0]),e.colors.push(o[1]),e.colors.push(o[2]),e.colors.push(o[(p-1)*3]),e.colors.push(o[(p-1)*3+1]),e.colors.push(o[(p-1)*3+2]),e.colors.push(o[p*3]),e.colors.push(o[p*3+1]),e.colors.push(o[p*3+2])),n.material&&n.material.mappingType!=="AllSame"&&(e.materialIndex.push(s),e.materialIndex.push(s),e.materialIndex.push(s)),n.normal&&(e.normal.push(i[0]),e.normal.push(i[1]),e.normal.push(i[2]),e.normal.push(i[(p-1)*3]),e.normal.push(i[(p-1)*3+1]),e.normal.push(i[(p-1)*3+2]),e.normal.push(i[p*3]),e.normal.push(i[p*3+1]),e.normal.push(i[p*3+2])),n.uv&&n.uv.forEach(function(f,h){e.uvs[h]===void 0&&(e.uvs[h]=[]),e.uvs[h].push(l[h][0]),e.uvs[h].push(l[h][1]),e.uvs[h].push(l[h][(p-1)*2]),e.uvs[h].push(l[h][(p-1)*2+1]),e.uvs[h].push(l[h][p*2]),e.uvs[h].push(l[h][p*2+1])})}addMorphTargets(e,n,t,s){if(t.length===0)return;e.morphTargetsRelative=!0,e.morphAttributes.position=[];const i=this;t.forEach(function(o){o.rawTargets.forEach(function(l){const a=T.Objects.Geometry[l.geoID];a!==void 0&&i.genMorphGeometry(e,n,a,s,l.name)})})}genMorphGeometry(e,n,t,s,i){const o=n.PolygonVertexIndex!==void 0?n.PolygonVertexIndex.a:[],l=t.Vertices!==void 0?t.Vertices.a:[],a=t.Indexes!==void 0?t.Indexes.a:[],c=e.attributes.position.count*3,u=new Float32Array(c);for(let m=0;m<a.length;m++){const y=a[m]*3;u[y]=l[m*3],u[y+1]=l[m*3+1],u[y+2]=l[m*3+2]}const p={vertexIndices:o,vertexPositions:u},f=this.genBuffers(p),h=new ge(f.vertex,3);h.name=i||t.attrName,h.applyMatrix4(s),e.morphAttributes.position.push(h)}parseNormals(e){const n=e.MappingInformationType,t=e.ReferenceInformationType,s=e.Normals.a;let i=[];return t==="IndexToDirect"&&("NormalIndex"in e?i=e.NormalIndex.a:"NormalsIndex"in e&&(i=e.NormalsIndex.a)),{dataSize:3,buffer:s,indices:i,mappingType:n,referenceType:t}}parseUVs(e){const n=e.MappingInformationType,t=e.ReferenceInformationType,s=e.UV.a;let i=[];return t==="IndexToDirect"&&(i=e.UVIndex.a),{dataSize:2,buffer:s,indices:i,mappingType:n,referenceType:t}}parseVertexColors(e){const n=e.MappingInformationType,t=e.ReferenceInformationType,s=e.Colors.a;let i=[];return t==="IndexToDirect"&&(i=e.ColorIndex.a),{dataSize:4,buffer:s,indices:i,mappingType:n,referenceType:t}}parseMaterialIndices(e){const n=e.MappingInformationType,t=e.ReferenceInformationType;if(n==="NoMappingInformation")return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:t};const s=e.Materials.a,i=[];for(let o=0;o<s.length;++o)i.push(o);return{dataSize:1,buffer:s,indices:i,mappingType:n,referenceType:t}}parseNurbsGeometry(e){const n=parseInt(e.Order);if(isNaN(n))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new nt;const t=n-1,s=e.KnotVector.a,i=[],o=e.Points.a;for(let p=0,f=o.length;p<f;p+=4)i.push(new Ge().fromArray(o,p));let l,a;if(e.Form==="Closed")i.push(i[0]);else if(e.Form==="Periodic"){l=t,a=s.length-1-l;for(let p=0;p<t;++p)i.push(i[p])}const u=new br(t,s,i,l,a).getPoints(i.length*12);return new nt().setFromPoints(u)}}class Tr{parse(){const e=[],n=this.parseClips();if(n!==void 0)for(const t in n){const s=n[t],i=this.addClip(s);e.push(i)}return e}parseClips(){if(T.Objects.AnimationCurve===void 0)return;const e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);const n=this.parseAnimationLayers(e);return this.parseAnimStacks(n)}parseAnimationCurveNodes(){const e=T.Objects.AnimationCurveNode,n=new Map;for(const t in e){const s=e[t];if(s.attrName.match(/S|R|T|DeformPercent/)!==null){const i={id:s.id,attr:s.attrName,curves:{}};n.set(i.id,i)}}return n}parseAnimationCurves(e){const n=T.Objects.AnimationCurve;for(const t in n){const s={id:n[t].id,times:n[t].KeyTime.a.map(Ir),values:n[t].KeyValueFloat.a},i=I.get(s.id);if(i!==void 0){const o=i.parents[0].ID,l=i.parents[0].relationship;l.match(/X/)?e.get(o).curves.x=s:l.match(/Y/)?e.get(o).curves.y=s:l.match(/Z/)?e.get(o).curves.z=s:l.match(/d|DeformPercent/)&&e.has(o)&&(e.get(o).curves.morph=s)}}}parseAnimationLayers(e){const n=T.Objects.AnimationLayer,t=new Map;for(const s in n){const i=[],o=I.get(parseInt(s));o!==void 0&&(o.children.forEach(function(a,c){if(e.has(a.ID)){const u=e.get(a.ID);if(u.curves.x!==void 0||u.curves.y!==void 0||u.curves.z!==void 0){if(i[c]===void 0){const p=I.get(a.ID).parents.filter(function(f){return f.relationship!==void 0})[0].ID;if(p!==void 0){const f=T.Objects.Model[p.toString()];if(f===void 0){console.warn("THREE.FBXLoader: Encountered a unused curve.",a);return}const h={modelName:f.attrName?He.sanitizeNodeName(f.attrName):"",ID:f.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};B.traverse(function(m){m.ID===f.id&&(h.transform=m.matrix,m.userData.transformData&&(h.eulerOrder=m.userData.transformData.eulerOrder))}),h.transform||(h.transform=new S),"PreRotation"in f&&(h.preRotation=f.PreRotation.value),"PostRotation"in f&&(h.postRotation=f.PostRotation.value),i[c]=h}}i[c]&&(i[c][u.attr]=u)}else if(u.curves.morph!==void 0){if(i[c]===void 0){const p=I.get(a.ID).parents.filter(function(w){return w.relationship!==void 0})[0].ID,f=I.get(p).parents[0].ID,h=I.get(f).parents[0].ID,m=I.get(h).parents[0].ID,y=T.Objects.Model[m],v={modelName:y.attrName?He.sanitizeNodeName(y.attrName):"",morphName:T.Objects.Deformer[p].attrName};i[c]=v}i[c][u.attr]=u}}}),t.set(parseInt(s),i))}return t}parseAnimStacks(e){const n=T.Objects.AnimationStack,t={};for(const s in n){const i=I.get(parseInt(s)).children;i.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");const o=e.get(i[0].ID);t[s]={name:n[s].attrName,layer:o}}return t}addClip(e){let n=[];const t=this;return e.layer.forEach(function(s){n=n.concat(t.generateTracks(s))}),new yn(e.name,-1,n)}generateTracks(e){const n=[];let t=new F,s=new be,i=new F;if(e.transform&&e.transform.decompose(t,s,i),t=t.toArray(),s=new oe().setFromQuaternion(s,e.eulerOrder).toArray(),i=i.toArray(),e.T!==void 0&&Object.keys(e.T.curves).length>0){const o=this.generateVectorTrack(e.modelName,e.T.curves,t,"position");o!==void 0&&n.push(o)}if(e.R!==void 0&&Object.keys(e.R.curves).length>0){const o=this.generateRotationTrack(e.modelName,e.R.curves,s,e.preRotation,e.postRotation,e.eulerOrder);o!==void 0&&n.push(o)}if(e.S!==void 0&&Object.keys(e.S.curves).length>0){const o=this.generateVectorTrack(e.modelName,e.S.curves,i,"scale");o!==void 0&&n.push(o)}if(e.DeformPercent!==void 0){const o=this.generateMorphTrack(e);o!==void 0&&n.push(o)}return n}generateVectorTrack(e,n,t,s){const i=this.getTimesForAllAxes(n),o=this.getKeyframeTrackValues(i,n,t);return new Es(e+"."+s,i,o)}generateRotationTrack(e,n,t,s,i,o){n.x!==void 0&&(this.interpolateRotations(n.x),n.x.values=n.x.values.map(q.degToRad)),n.y!==void 0&&(this.interpolateRotations(n.y),n.y.values=n.y.values.map(q.degToRad)),n.z!==void 0&&(this.interpolateRotations(n.z),n.z.values=n.z.values.map(q.degToRad));const l=this.getTimesForAllAxes(n),a=this.getKeyframeTrackValues(l,n,t);s!==void 0&&(s=s.map(q.degToRad),s.push(o),s=new oe().fromArray(s),s=new be().setFromEuler(s)),i!==void 0&&(i=i.map(q.degToRad),i.push(o),i=new oe().fromArray(i),i=new be().setFromEuler(i).invert());const c=new be,u=new oe,p=[];for(let f=0;f<a.length;f+=3)u.set(a[f],a[f+1],a[f+2],o),c.setFromEuler(u),s!==void 0&&c.premultiply(s),i!==void 0&&c.multiply(i),c.toArray(p,f/3*4);return new Ps(e+".quaternion",l,p)}generateMorphTrack(e){const n=e.DeformPercent.curves.morph,t=n.values.map(function(i){return i/100}),s=B.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new Ts(e.modelName+".morphTargetInfluences["+s+"]",n.times,t)}getTimesForAllAxes(e){let n=[];if(e.x!==void 0&&(n=n.concat(e.x.times)),e.y!==void 0&&(n=n.concat(e.y.times)),e.z!==void 0&&(n=n.concat(e.z.times)),n=n.sort(function(t,s){return t-s}),n.length>1){let t=1,s=n[0];for(let i=1;i<n.length;i++){const o=n[i];o!==s&&(n[t]=o,s=o,t++)}n=n.slice(0,t)}return n}getKeyframeTrackValues(e,n,t){const s=t,i=[];let o=-1,l=-1,a=-1;return e.forEach(function(c){if(n.x&&(o=n.x.times.indexOf(c)),n.y&&(l=n.y.times.indexOf(c)),n.z&&(a=n.z.times.indexOf(c)),o!==-1){const u=n.x.values[o];i.push(u),s[0]=u}else i.push(s[0]);if(l!==-1){const u=n.y.values[l];i.push(u),s[1]=u}else i.push(s[1]);if(a!==-1){const u=n.z.values[a];i.push(u),s[2]=u}else i.push(s[2])}),i}interpolateRotations(e){for(let n=1;n<e.values.length;n++){const t=e.values[n-1],s=e.values[n]-t,i=Math.abs(s);if(i>=180){const o=i/180,l=s/o;let a=t+l;const c=e.times[n-1],p=(e.times[n]-c)/o;let f=c+p;const h=[],m=[];for(;f<e.times[n];)h.push(f),f+=p,m.push(a),a+=l;e.times=qt(e.times,n,h),e.values=qt(e.values,n,m)}}}}class Ar{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(e){this.nodeStack.push(e),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(e,n){this.currentProp=e,this.currentPropName=n}parse(e){this.currentIndent=0,this.allNodes=new Dn,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const n=this,t=e.split(/[\r\n]+/);return t.forEach(function(s,i){const o=s.match(/^[\s\t]*;/),l=s.match(/^[\s\t]*$/);if(o||l)return;const a=s.match("^\\t{"+n.currentIndent+"}(\\w+):(.*){",""),c=s.match("^\\t{"+n.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),u=s.match("^\\t{"+(n.currentIndent-1)+"}}");a?n.parseNodeBegin(s,a):c?n.parseNodeProperty(s,c,t[++i]):u?n.popStack():s.match(/^[^\s\t}]/)&&n.parseNodePropertyContinued(s)}),this.allNodes}parseNodeBegin(e,n){const t=n[1].trim().replace(/^"/,"").replace(/"$/,""),s=n[2].split(",").map(function(a){return a.trim().replace(/^"/,"").replace(/"$/,"")}),i={name:t},o=this.parseNodeAttr(s),l=this.getCurrentNode();this.currentIndent===0?this.allNodes.add(t,i):t in l?(t==="PoseNode"?l.PoseNode.push(i):l[t].id!==void 0&&(l[t]={},l[t][l[t].id]=l[t]),o.id!==""&&(l[t][o.id]=i)):typeof o.id=="number"?(l[t]={},l[t][o.id]=i):t!=="Properties70"&&(t==="PoseNode"?l[t]=[i]:l[t]=i),typeof o.id=="number"&&(i.id=o.id),o.name!==""&&(i.attrName=o.name),o.type!==""&&(i.attrType=o.type),this.pushStack(i)}parseNodeAttr(e){let n=e[0];e[0]!==""&&(n=parseInt(e[0]),isNaN(n)&&(n=e[0]));let t="",s="";return e.length>1&&(t=e[1].replace(/^(\w+)::/,""),s=e[2]),{id:n,name:t,type:s}}parseNodeProperty(e,n,t){let s=n[1].replace(/^"/,"").replace(/"$/,"").trim(),i=n[2].replace(/^"/,"").replace(/"$/,"").trim();s==="Content"&&i===","&&(i=t.replace(/"/g,"").replace(/,$/,"").trim());const o=this.getCurrentNode();if(o.name==="Properties70"){this.parseNodeSpecialProperty(e,s,i);return}if(s==="C"){const a=i.split(",").slice(1),c=parseInt(a[0]),u=parseInt(a[1]);let p=i.split(",").slice(3);p=p.map(function(f){return f.trim().replace(/^"/,"")}),s="connections",i=[c,u],Dr(i,p),o[s]===void 0&&(o[s]=[])}s==="Node"&&(o.id=i),s in o&&Array.isArray(o[s])?o[s].push(i):s!=="a"?o[s]=i:o.a=i,this.setCurrentProp(o,s),s==="a"&&i.slice(-1)!==","&&(o.a=ot(i))}parseNodePropertyContinued(e){const n=this.getCurrentNode();n.a+=e,e.slice(-1)!==","&&(n.a=ot(n.a))}parseNodeSpecialProperty(e,n,t){const s=t.split('",').map(function(u){return u.trim().replace(/^\"/,"").replace(/\s/,"_")}),i=s[0],o=s[1],l=s[2],a=s[3];let c=s[4];switch(o){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":c=parseFloat(c);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":c=ot(c);break}this.getPrevNode()[i]={type:o,type2:l,flag:a,value:c},this.setCurrentProp(this.getPrevNode(),i)}}class Mr{parse(e){const n=new Kt(e);n.skip(23);const t=n.getUint32();if(t<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+t);const s=new Dn;for(;!this.endOfContent(n);){const i=this.parseNode(n,t);i!==null&&s.add(i.name,i)}return s}endOfContent(e){return e.size()%16===0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()}parseNode(e,n){const t={},s=n>=7500?e.getUint64():e.getUint32(),i=n>=7500?e.getUint64():e.getUint32();n>=7500?e.getUint64():e.getUint32();const o=e.getUint8(),l=e.getString(o);if(s===0)return null;const a=[];for(let f=0;f<i;f++)a.push(this.parseProperty(e));const c=a.length>0?a[0]:"",u=a.length>1?a[1]:"",p=a.length>2?a[2]:"";for(t.singleProperty=i===1&&e.getOffset()===s;s>e.getOffset();){const f=this.parseNode(e,n);f!==null&&this.parseSubNode(l,t,f)}return t.propertyList=a,typeof c=="number"&&(t.id=c),u!==""&&(t.attrName=u),p!==""&&(t.attrType=p),l!==""&&(t.name=l),t}parseSubNode(e,n,t){if(t.singleProperty===!0){const s=t.propertyList[0];Array.isArray(s)?(n[t.name]=t,t.a=s):n[t.name]=s}else if(e==="Connections"&&t.name==="C"){const s=[];t.propertyList.forEach(function(i,o){o!==0&&s.push(i)}),n.connections===void 0&&(n.connections=[]),n.connections.push(s)}else if(t.name==="Properties70")Object.keys(t).forEach(function(i){n[i]=t[i]});else if(e==="Properties70"&&t.name==="P"){let s=t.propertyList[0],i=t.propertyList[1];const o=t.propertyList[2],l=t.propertyList[3];let a;s.indexOf("Lcl ")===0&&(s=s.replace("Lcl ","Lcl_")),i.indexOf("Lcl ")===0&&(i=i.replace("Lcl ","Lcl_")),i==="Color"||i==="ColorRGB"||i==="Vector"||i==="Vector3D"||i.indexOf("Lcl_")===0?a=[t.propertyList[4],t.propertyList[5],t.propertyList[6]]:a=t.propertyList[4],n[s]={type:i,type2:o,flag:l,value:a}}else n[t.name]===void 0?typeof t.id=="number"?(n[t.name]={},n[t.name][t.id]=t):n[t.name]=t:t.name==="PoseNode"?(Array.isArray(n[t.name])||(n[t.name]=[n[t.name]]),n[t.name].push(t)):n[t.name][t.id]===void 0&&(n[t.name][t.id]=t)}parseProperty(e){const n=e.getString(1);let t;switch(n){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":return t=e.getUint32(),e.getArrayBuffer(t);case"S":return t=e.getUint32(),e.getString(t);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const s=e.getUint32(),i=e.getUint32(),o=e.getUint32();if(i===0)switch(n){case"b":case"c":return e.getBooleanArray(s);case"d":return e.getFloat64Array(s);case"f":return e.getFloat32Array(s);case"i":return e.getInt32Array(s);case"l":return e.getInt64Array(s)}const l=ur(new Uint8Array(e.getArrayBuffer(o))),a=new Kt(l.buffer);switch(n){case"b":case"c":return a.getBooleanArray(s);case"d":return a.getFloat64Array(s);case"f":return a.getFloat32Array(s);case"i":return a.getInt32Array(s);case"l":return a.getInt64Array(s)}break;default:throw new Error("THREE.FBXLoader: Unknown property type "+n)}}}class Kt{constructor(e,n){this.dv=new DataView(e),this.offset=0,this.littleEndian=n!==void 0?n:!0,this._textDecoder=new TextDecoder}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(e){this.offset+=e}getBoolean(){return(this.getUint8()&1)===1}getBooleanArray(e){const n=[];for(let t=0;t<e;t++)n.push(this.getBoolean());return n}getUint8(){const e=this.dv.getUint8(this.offset);return this.offset+=1,e}getInt16(){const e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}getInt32(){const e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}getInt32Array(e){const n=[];for(let t=0;t<e;t++)n.push(this.getInt32());return n}getUint32(){const e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}getInt64(){let e,n;return this.littleEndian?(e=this.getUint32(),n=this.getUint32()):(n=this.getUint32(),e=this.getUint32()),n&2147483648?(n=~n&4294967295,e=~e&4294967295,e===4294967295&&(n=n+1&4294967295),e=e+1&4294967295,-(n*4294967296+e)):n*4294967296+e}getInt64Array(e){const n=[];for(let t=0;t<e;t++)n.push(this.getInt64());return n}getUint64(){let e,n;return this.littleEndian?(e=this.getUint32(),n=this.getUint32()):(n=this.getUint32(),e=this.getUint32()),n*4294967296+e}getFloat32(){const e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}getFloat32Array(e){const n=[];for(let t=0;t<e;t++)n.push(this.getFloat32());return n}getFloat64(){const e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}getFloat64Array(e){const n=[];for(let t=0;t<e;t++)n.push(this.getFloat64());return n}getArrayBuffer(e){const n=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,n}getString(e){const n=this.offset;let t=new Uint8Array(this.dv.buffer,n,e);this.skip(e);const s=t.indexOf(0);return s>=0&&(t=new Uint8Array(this.dv.buffer,n,s)),this._textDecoder.decode(t)}}class Dn{add(e,n){this[e]=n}}function Lr(r){const e="Kaydara FBX Binary  \0";return r.byteLength>=e.length&&e===Fn(r,0,e.length)}function Sr(r){const e=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let n=0;function t(s){const i=r[s-1];return r=r.slice(n+s),n++,i}for(let s=0;s<e.length;++s)if(t(1)===e[s])return!1;return!0}function Zt(r){const e=/FBXVersion: (\d+)/,n=r.match(e);if(n)return parseInt(n[1]);throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function Ir(r){return r/46186158e3}const Cr=[];function je(r,e,n,t){let s;switch(t.mappingType){case"ByPolygonVertex":s=r;break;case"ByPolygon":s=e;break;case"ByVertice":s=n;break;case"AllSame":s=t.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+t.mappingType)}t.referenceType==="IndexToDirect"&&(s=t.indices[s]);const i=s*t.dataSize,o=i+t.dataSize;return Or(Cr,t.buffer,i,o)}const at=new oe,ye=new F;function On(r){const e=new S,n=new S,t=new S,s=new S,i=new S,o=new S,l=new S,a=new S,c=new S,u=new S,p=new S,f=new S,h=r.inheritType?r.inheritType:0;if(r.translation&&e.setPosition(ye.fromArray(r.translation)),r.preRotation){const C=r.preRotation.map(q.degToRad);C.push(r.eulerOrder||oe.DEFAULT_ORDER),n.makeRotationFromEuler(at.fromArray(C))}if(r.rotation){const C=r.rotation.map(q.degToRad);C.push(r.eulerOrder||oe.DEFAULT_ORDER),t.makeRotationFromEuler(at.fromArray(C))}if(r.postRotation){const C=r.postRotation.map(q.degToRad);C.push(r.eulerOrder||oe.DEFAULT_ORDER),s.makeRotationFromEuler(at.fromArray(C)),s.invert()}r.scale&&i.scale(ye.fromArray(r.scale)),r.scalingOffset&&l.setPosition(ye.fromArray(r.scalingOffset)),r.scalingPivot&&o.setPosition(ye.fromArray(r.scalingPivot)),r.rotationOffset&&a.setPosition(ye.fromArray(r.rotationOffset)),r.rotationPivot&&c.setPosition(ye.fromArray(r.rotationPivot)),r.parentMatrixWorld&&(p.copy(r.parentMatrix),u.copy(r.parentMatrixWorld));const m=n.clone().multiply(t).multiply(s),y=new S;y.extractRotation(u);const v=new S;v.copyPosition(u);const w=v.clone().invert().multiply(u),b=y.clone().invert().multiply(w),g=i,P=new S;if(h===0)P.copy(y).multiply(m).multiply(b).multiply(g);else if(h===1)P.copy(y).multiply(b).multiply(m).multiply(g);else{const se=new S().scale(new F().setFromMatrixScale(p)).clone().invert(),Q=b.clone().multiply(se);P.copy(y).multiply(m).multiply(Q).multiply(g)}const x=c.clone().invert(),A=o.clone().invert();let _=e.clone().multiply(a).multiply(c).multiply(n).multiply(t).multiply(s).multiply(x).multiply(l).multiply(o).multiply(i).multiply(A);const L=new S().copyPosition(_),U=u.clone().multiply(L);return f.copyPosition(U),_=f.clone().multiply(P),_.premultiply(u.invert()),_}function kn(r){r=r||0;const e=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return r===6?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),e[0]):e[r]}function ot(r){return r.split(",").map(function(n){return parseFloat(n)})}function Fn(r,e,n){return e===void 0&&(e=0),n===void 0&&(n=r.byteLength),new TextDecoder().decode(new Uint8Array(r,e,n))}function Dr(r,e){for(let n=0,t=r.length,s=e.length;n<s;n++,t++)r[t]=e[n]}function Or(r,e,n,t){for(let s=n,i=0;s<t;s++,i++)r[i]=e[s];return r}function qt(r,e,n){return r.slice(0,e).concat(n).concat(r.slice(e))}const Rn=r=>r&&new Promise(e=>{new xr().load(r,e)}),_n=r=>r&&new Promise(e=>{new xe().load(r,e)}),kr=["px.png","nx.png","py.png","ny.png","pz.png","nz.png"],Fr=r=>r&&new Promise(e=>{new As().setPath(`${r}/`).load(kr,e)}),Rr=["c100007_01","c100007_05","c100007_09","c100034_01","c100035_01","c100036_01","c100037_01","c100041_01"],_r=async r=>await(await fetch(r)).json(),We=async r=>(await _r(r)).data,Br=(...r)=>e=>r.reduce((n,t)=>t(n),e),jr=r=>[...new Set(r)],te=r=>r==="false"?!1:!!r,Bn=(r,e,n)=>{if(!e.length)return;const t=e.pop(),s=e.reduce((i,o)=>i==null?void 0:i[o],r);s&&(s[t]=n)};function Et(r){return!!/[0-9A-Fa-f]{6}/.test(r)}function Ve(r){return Et(r)&&!r.startsWith("#")?new R(`#${r}`):new R(r)}async function Ur(r=100){return await new Promise(e=>setTimeout(e,r))}function jn(r,e="="){const[n,...t]=r.split(e),s=t.join(e);return[n,s]}const zr=r=>r.startsWith("w302"),Qt=([r,...e])=>`${r.toUpperCase()}${e.join("")}`;function Nr(r){return r==="smith"?"dragon":r.endsWith("h")?"story":Rr.includes(r)?"spAdventurer":{c:"adventurer",b:"boss",d:"dragon",e:"enemy",h:"high boss",o:"object",r:"raid boss",w:"weapon"}[r[0]]??"other"}function Vr(r=li){const e=new Ms(r);return e.outputEncoding=G,e}function $r(r={}){const{fov:e,aspect:n,near:t,far:s}={...pi,...r};return new dn(e,n,t,s)}async function Hr(r){if(r.startsWith("img:")){const e=r.replace("img:",""),n=await _n(e);return n.encoding=G,n.center.set(.5,0),n}if(r.startsWith("sky:")){const e=r.replace("sky:",""),n=await Fr(e);return n.encoding=G,n}if(r==="transparent")return null;if(Et(r)){const e=r.startsWith("#")?r:`#${r}`;return new R(e)}}function Gr(r){var e,n,t,s;(n=(e=r.map)==null?void 0:e.dispose)==null||n.call(e),(s=(t=r.userData.backupMap)==null?void 0:t.dispose)==null||s.call(t),r.dispose()}const Un=r=>{const e=new xe().load(r);return e.encoding=G,e};function Xr(r){const e=[],n=[];return r.traverse(t=>{t.isMesh&&e.push(t),t.isBone&&n.push(t)}),[e,n]}function Wr(r){var n,t;if(!r)return;[r.material].flat().forEach(s=>{var i,o,l,a,c,u;(o=(i=s.map)==null?void 0:i.dispose)==null||o.call(i),(c=(a=(l=s.userData)==null?void 0:l.backupMap)==null?void 0:a.dispose)==null||c.call(a),(u=s.dispose)==null||u.call(s)}),(t=(n=r.geometry)==null?void 0:n.dispose)==null||t.call(n)}const Yr=()=>{const r=new Date,e=r.toDateString().replaceAll(" ","_"),n=r.toLocaleTimeString().replaceAll(":","-").replaceAll(" ","");return`${e}_${n}`},zn=r=>r?r.split("/").reduce((n,t)=>{const[s,i]=t.split("=");return s&&i&&(n[s]=i),n},{}):{},Kr=`
varying vec3 vViewPosition;

struct BlinnPhongMaterial {

	vec3 diffuseColor;
	vec3 specularColor;
	float specularShininess;
	float specularStrength;

};

void RE_Direct_BlinnPhong( const in IncidentLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {

	vec3 irradiance = getGradientIrradiance( geometry.normal, directLight.direction ) * directLight.color;

	reflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );

	reflectedLight.directSpecular += irradiance * BRDF_BlinnPhong( directLight.direction, geometry.viewDir, geometry.normal, material.specularColor, material.specularShininess ) * material.specularStrength;

}

void RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {

	reflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );

}

#define RE_Direct				RE_Direct_BlinnPhong
#define RE_IndirectDiffuse		RE_IndirectDiffuse_BlinnPhong
`,Zr=`
#ifdef USE_MATCAP

	vec3 viewDir = normalize( vViewPosition );
	vec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );
	vec3 y = cross( viewDir, x );
	vec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5; // 0.495 to remove artifacts caused by undersized matcap disks
	vec4 matcapColor = texture2D( matcap, uv );

	#ifdef MATCAP_BLENDING_MULTIPLY

		outgoingLight *= matcapColor.rgb;

	#elif defined( MATCAP_BLENDING_ADD )

		outgoingLight += matcapColor.rgb;

	#endif

#endif
`,Ue={defines:{TOON:!0,MATCAP:!0,MATCAP_BLENDING_ADD:!0},uniforms:vn.merge([Le.toon.uniforms,Le.phong.uniforms,Le.matcap.uniforms]),vertexShader:Le.phong.vertexShader.replace("#include <envmap_pars_vertex>","").replace("#include <envmap_vertex>",""),fragmentShader:Le.phong.fragmentShader.replace("#include <common>",`
					#ifdef USE_MATCAP
						uniform sampler2D matcap;
					#endif

					#include <common>
				`).replace("#include <envmap_common_pars_fragment>",`
					#include <gradientmap_pars_fragment>
				`).replace("#include <envmap_pars_fragment>","").replace("#include <lights_phong_pars_fragment>",Kr).replace("#include <envmap_fragment>",`
					${Zr}
				`)};class Nn extends bt{constructor(e){super(),this._matcapCombine=$t,this.emissiveIntensity=1,this.normalMapType=Ls,this.combine=Ht,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.lights=!0,this.vertexShader=Ue.vertexShader,this.fragmentShader=Ue.fragmentShader,this.defines=Object.assign({},Ue.defines),Object.defineProperty(this,"matcapCombine",{get:function(){return this._matcapCombine},set:function(t){switch(this._matcapCombine=t,t){case Ht:this.defines.MATCAP_BLENDING_MULTIPLY=!0,delete this.defines.MATCAP_BLENDING_ADD;break;default:case $t:this.defines.MATCAP_BLENDING_ADD=!0,delete this.defines.MATCAP_BLENDING_MULTIPLY;break}}}),this.uniforms=vn.clone(Ue.uniforms);const n=["specular","shininess","opacity","diffuse","map","matcap","gradientMap","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveMap","bumpMap","bumpScale","normalMap","normalScale","displacemantBias","displacemantMap","displacemantScale","specularMap","alphaMap","envMap","reflectivity","refractionRatio"];for(const t of n)Object.defineProperty(this,t,{get:function(){return this.uniforms[t].value},set:function(s){this.uniforms[t].value=s}});Object.defineProperty(this,"color",Object.getOwnPropertyDescriptor(this,"diffuse")),this.setValues(e)}copy(e){return super.copy(e),this.matcapCombine=e.matcapCombine,this.emissiveIntensity=e.emissiveIntensity,this.normalMapType=e.normalMapType,this.combine=e.combine,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this}}Nn.prototype.isMMDToonMaterial=!0;const qr=["color","emissive","specular"],Qr=["wireframe","metalness","opacity","roughness","shininess","transparent","emissiveIntensity","transmission","thickness","ior"],Vn=["type","flatShading","showTexture","gradientMap","matcap"],Jr=[...qr,...Qr,...Vn],ei=["transparent","opacity","wireframe","showTexture","color"],ti={Basic:[],Toon:["emissive","emissiveIntensity","gradientMap"],Lambert:["emissive","emissiveIntensity"],Phong:["emissive","emissiveIntensity","specular","shininess","flatShading"],Standard:["emissive","emissiveIntensity","metalness","roughness","flatShading"],Physical:["emissive","emissiveIntensity","metalness","roughness","flatShading","transmission","thickness","ior"],Matcap:["flatShading","matcap"],MMDToon:["emissive","emissiveIntensity","specular","shininess","matcap","gradientMap","flatShading"]},N=r=>`${r}`,ct=r=>Et(r)?`${r.startsWith("#")?"":"#"}${r}`:r,ni=r=>Array.isArray(r)?r.join(","):r,Pt={wireframe:{name:"Wireframe",type:"boolean",default:!1,valueMap:te,toString:N},showTexture:{name:"Texture",type:"boolean",default:!0,valueMap:te,toString:N},transparent:{name:"Transparent",type:"boolean",default:!1,valueMap:te,toString:N},flatShading:{name:"Flat Shading",type:"boolean",default:!1,valueMap:te,toString:N},color:{name:"Color",type:"color",default:"#ffffff",valueMap:Ve,toString:ct},emissive:{name:"Emissive",type:"color",default:"#000000",valueMap:Ve,toString:ct},opacity:{name:"Opacity",type:"percentage",default:1,min:0,max:1,valueMap:parseFloat,toString:N},emissiveIntensity:{name:"Emissive Intensity",type:"percentage",default:1,min:0,max:1,valueMap:parseFloat,toString:N},specular:{name:"Specular",type:"color",default:"#111111",valueMap:Ve,toString:ct},metalness:{name:"Metalness",type:"percentage",default:0,min:0,max:1,valueMap:parseFloat,toString:N},roughness:{name:"Roughness",type:"percentage",default:1,min:0,max:1,valueMap:parseFloat,toString:N},shininess:{name:"Shininess",type:"number",default:30,min:1,max:100,valueMap:parseFloat,toString:N},gradientMap:{name:"Gradient Map",type:"select",default:"none",valueMap:$n,toString:ni},matcap:{name:"Matcap",type:"select",default:"matcap_fresnel.jpg",valueMap:Hn,toString:N},transmission:{name:"Transmission",type:"number",default:1,min:0,max:1,valueMap:parseFloat,toString:N},thickness:{name:"Thickness",type:"number",default:.01,min:0,max:10,valueMap:parseFloat,toString:N},ior:{name:"Index-of-refraction",type:"number",default:1.5,min:1,max:2.333,valueMap:parseFloat,toString:N}},si=Object.fromEntries(Object.entries(Pt).map(([r,{default:e}])=>[r,e])),ue={...si,type:"Basic"},ri=Object.fromEntries(Object.entries(Pt).map(([r,{valueMap:e}])=>[r,e])),ii=Object.fromEntries(Object.entries(Pt).map(([r,{toString:e}])=>[r,e])),lt=r=>[...ei,...ti[r]],ai=(r,e={})=>{if(r==="MMDToon")return new Nn(e);const n=`Mesh${r}Material`;return new wn[n](e)},Jt=(r,{matType:e="Basic",texturePath:n="",force:t=!1}={})=>{r.forEach(s=>{const i=[s.material].flat(),o=Array.isArray(s.material);if(!t&&!n){const l=`isMesh${e}Material`;if(!i.some(c=>!c[l]))return}i.forEach((l,a)=>{var p,f,h,m;const c=n?new xe().load(n):i[a].map;n&&(c.encoding=G);const u=ai(e);if(u.name=l.name,u.map=c,u.userData.backupMap=l.userData.backupMap,n&&((f=(p=l.map)==null?void 0:p.dispose)==null||f.call(p),(m=(h=l.userData.backupMap)==null?void 0:h.dispose)==null||m.call(h)),l.dispose(),o){s.material[a]=u;return}s.material=u})})},oi=r=>Array.isArray(r)?r:r.split(",").map(e=>parseInt(e));function $n(r){const e=oi(r),n=e.length;if(n<2)return null;const t=Uint8Array.from(e),s=new Ss(t,n,1,Is);return s.minFilter=s.magFilter=Cs,s.generateMipmaps=!1,s}const ci=r=>r.includes("/")||r.includes(":")?r:`${Qs}/${r}`;function Hn(r){const e=ci(r);return e?Un(e):null}const li={alpha:!0,antialias:!0},ui="#cccccc",pi={type:"Perspective",fov:45,aspect:1,far:300,near:.01},fi="c100001_01",we={enabled:!0,size:5,color:"#000000",opacity:1},hi={noBackground:!0,fileName:"screenshot",frameRate:30},di={frameRate:30,fileName:"ani",appendDate:!0},en=1,mt=30,mi={directional:{color:"#ffffff",intensity:.8,position:[1,0,2]},ambient:{color:"#444444",intensity:1},point:{color:"#ffffff",intensity:1}},ut={"No Mapping":Ds,Linear:Os,Reinhard:ks,Cineon:Fs,"ACES Filmic":Rs},Oe={addEventListener(r,e){if(!e)return;this._listeners??(this._listeners={});const n=this._listeners;return r=r.toLowerCase(),n[r]??(n[r]=[]),n[r].includes(e)||n[r].push(e),e},hasEventListener(r,e){var n,t;return r=r.toLowerCase(),!!((t=(n=this._listeners)==null?void 0:n[r])!=null&&t.includes(e))},removeEventListener(r,e){var s;r=r.toLowerCase();const n=(s=this._listeners)==null?void 0:s[r];if(!n)return;const t=n.indexOf(e);t!==-1&&n.splice(t,1)},dispatchEvent(r){var s,i;const e=(s=r.type)==null?void 0:s.toLowerCase(),n=(i=this._listeners)==null?void 0:i[e];if(!n)return;r.target=this,[...n].forEach(o=>o.call(this,r))},addCountedEventListener(r,e,n=1){const t=this;function s(i){e.call(t,i),n--,n===0&&t.removeEventListener(r,s)}this.addEventListener(r,s)}},gi={face1:[2,1],face2:[0,0],face3:[1,0],face4:[2,0],face5:[3,0],face6:[0,-1],face7:[1,-1],face8:[2,-1],face9:[3,-1]},Gn={},yi=async()=>{const r=await We(`${Xe}/face-offset.json`);Object.assign(Gn,r)},tn=r=>Gn[r]||[0,0],gt={},vi=async()=>{const r=await We(`${Xe}/camera-position.json`);Object.assign(gt,r)},co=r=>gt[r]??gt[r[0]],yt={},wi=async()=>{const r=await We(`${Xe}/control-position.json`);Object.assign(yt,r)},lo=r=>yt[r]??yt[r[0]],nn=r=>gi[`face${r}`],bi=(r,e)=>{const n={x:0,y:0};if(r!==e){const[t,s]=nn(e),[i,o]=nn(r);n.x=i-t,n.y=o-s}return[n.x,n.y]},xi=(r,e)=>{const n={x:0,y:0};if(r!==e){const[t,s]=tn(e),[i,o]=tn(r);n.x=i-t,n.y=o-s}return[n.x,n.y]},Ye=r=>new Proxy(Object.assign(r,Oe),{get(e,n){return e[n]},set(e,n,t){return e[n]=t,e.dispatchEvent({type:"change",propName:n,value:t}),!0}}),Xn=/mEye_[0-9]/m,Wn=/mMouth_[0-9]/m,Ei=/[0-9]{2}/,Yn=["eye","mouth"];function Pi(r){const{type:e,meshes:n}=r;return e==="adventurer"?Ti(r):n.some(({name:s})=>s.match(/mEye|mMouth/))?Ai(r):r}function Ti(r){const{meshes:e,id:n}=r,t=c=>`${En}/${c}/${c}.png`,s=e.find(({name:c})=>c==="mBodyAll"),i={eyeIdx:2,eyeBaseIdx:2,mouthIdx:2,mouthBaseIdx:2,eyeTexture:n,mouthTexture:n},o={type:"uv",reset:function(){this.eyeIdx=this.eyeBaseIdx,this.mouthIdx=this.mouthBaseIdx}},l=c=>([u,p])=>{var b;if(!s)return;const f=`mt${Qt(c)}CH`,h=(b=s.geometry.groups)==null?void 0:b.find(g=>{var P;return((P=s.material[g.materialIndex])==null?void 0:P.name)===f});if(!h)return;const{start:m,count:y}=h,v=m+y,w=s.geometry.attributes.uv;for(let g=m;g<v;g++){const P=w.getX(g)+.25*u,x=w.getY(g)+.25*p;w.setXY(g,P,x)}w.needsUpdate=!0},a=c=>u=>{var m,y;if(!s)return;const p=`mt${Qt(c)}CH`,f=(y=(m=s.material).find)==null?void 0:y.call(m,({name:v})=>v===p);if(!f)return;const h=t(u);f.map.dispose(),f.map=Un(h),f.needsUpdate=!0};return Yn.forEach(c=>{Object.defineProperties(o,{[`${c}Idx`]:{get(){return i[`${c}Idx`]},set(u){const p=parseInt(u),f=this[`${c}Idx`];i[`${c}Idx`]=p;const h=bi(p,f);l(c)(h)}},[`${c}BaseIdx`]:{get(){return i[`${c}BaseIdx`]},set(u){i[`${c}BaseIdx`]=u,this[`${c}Idx`]=u}},[`${c}Texture`]:{get(){return i[`${c}Texture`]},set(u){const p=this[`${c}Texture`];i[`${c}Texture`]=u,a(c)(u);const f=xi(u,p);l(c)(f)}}})}),r.face=Ye(o),r}function Ai(r){const{meshes:e}=r,[n,t]=Mi(e);[...n,...t].forEach(a=>a.frustumCulled=!1);const s={eye:n,mouth:t},i={eyeIdx:"",eyeBaseIdx:"",mouthIdx:"",mouthBaseIdx:""},o={eyeList:n,mouthList:t,type:"meshes",reset:function(){this.eyeIdx=this.eyeBaseIdx,this.mouthIdx=this.mouthBaseIdx}},l=a=>c=>{s[a].forEach(u=>{const{name:p}=u,f=Ei.exec(p)[0];u.visible=parseInt(f)===c})};return Yn.forEach(a=>Object.defineProperties(o,{[`${a}Idx`]:{get(){return i[`${a}Idx`]},set(c){const u=parseInt(c);l(a)(u),i[`${a}Idx`]=`${u}`}},[`${a}BaseIdx`]:{get(){return i[`${a}BaseIdx`]},set(c){i[`${a}BaseIdx`]=c,this[`${a}Idx`]=c}}})),o.eyeBaseIdx=en,o.mouthBaseIdx=en,r.face=Ye(o),r}function Mi(r){const e=r.filter(({name:t})=>t.match(Xn)),n=r.filter(({name:t})=>t.match(Wn));return[e,n]}function Li(r){const{model:e,uniqueId:n}=r,[t,s]=Xr(e);return Object.defineProperty(s,"list",{value:jr(s.map(({name:i})=>i))}),Object.defineProperty(t,"visible",{get(){return this.filter(({visible:i})=>i)}}),s.forEach(i=>{i.name=`${n}|${i.name}`}),Object.defineProperties(r,{meshes:{get(){return t}},bones:{get(){return s}}})}const Kn={},Si=async()=>{const r=await We(`${Xe}/model-parts.json`);Object.assign(Kn,r)},Ii=r=>Kn[r],Ci=/mParts([A-Za-z]+)/,sn=/mParts[A-Za-z]+_([A-Za-z]*)/;function Di(r){const{meshes:e,id:n}=r,t=Ii(n),s=[],i=[];if(e.forEach(c=>{var p;let{name:u}=c;if(u!=null&&u.match){if((u.includes("Effect")||u.includes("Extension"))&&(c.visible=!1),(p=t==null?void 0:t.custom)!=null&&p[u]&&(u=c.name=t.custom[u]),u.match(/mParts/)){s.push(c);return}!u.match(Xn)&&!u.match(Wn)&&i.push(c)}}),!s.length&&i.length<2)return r;const o=Object.defineProperties({},{list:{get(){return Object.keys(this)},enumerable:!1},reset:{value:function(){this.list.forEach(c=>this[c].reset())},enumerable:!1},others:{get(){return i},enumerable:!1}});if(r.parts=o,!s.length)return r;const l=new Set(s.map(({name:c})=>{var u;return(u=Ci.exec(c))==null?void 0:u[1]}).sort((c,u)=>c>u?1:-1)),a=c=>s.filter(({name:u})=>u.includes(`mParts${c}`)).sort((u,p)=>u.name>p.name?1:-1);return l.forEach(c=>{var v;const u=t==null?void 0:t[c],p=((v=u==null?void 0:u.name)==null?void 0:v.replaceAll(" ","_"))??c,f=u==null?void 0:u.options,h=a(c);h.forEach(w=>w.frustumCulled=!1);const m=h.map(({name:w})=>{var g;const b=((g=sn.exec(w))==null?void 0:g[1])??"default";return(f==null?void 0:f[b])??b}),y=(u==null?void 0:u.default)??m[0];o[p]={_meshes:h,list:m,default:y??m[0]},Object.defineProperties(o[p],{current:{get(){var x;const w=h.filter(({visible:A})=>A).length;if(w===0)return"None";if(w!==1)return"custom";const g=(x=h.find(({visible:A})=>A).name.match(sn))==null?void 0:x[1];return(f==null?void 0:f[g??"default"])??g??"default"},set(w){if(w.toLowerCase()==="none"){this._meshes.forEach((g,P)=>{g.visible=!1});return}if(!this.list.includes(w))return;const b=this.list.indexOf(w);this._meshes.forEach((g,P)=>{g.visible=P===b})}},index:{get(){return this.current==="custom"?NaN:this.list.indexOf(this.current)},set(w){this._meshes.forEach((b,g)=>{b.visible=g===Number(w)})}},reset:{value:function(){this.current=this.default}}})}),o.reset(),r.parts=o,r}const Oi=r=>e=>{const n=e.meshes,t={...ue,...r},{type:s}=t;Jt(n,{force:!0,matType:s});let i={type:s,showTexture:!0},o=lt(s);const l={get code(){const{type:a,propList:c}=this,u=[];return a!==ue.type&&u.push(`type=${a}`),c.forEach(f=>{const h=ii[f],m=h(this[f]),y=h(ue[f]);m!==y&&u.push(`${f}=${m}`)}),u.join("/").replaceAll("#","")},set code(a){const c=Object.keys(ue),u={...ue,...zn(a)};c.forEach(p=>{this[p]=u[p]})},toString(){const{code:a}=this;return a?`mat=(${a})`:""},get list(){return n.flatMap(({material:a})=>a)},get propList(){return o},set type(a){if(this.type===a)return;o=lt(a),Jt(n,{matType:a}),i.type=a;const c={...i};i={showTexture:c.showTexture},o.forEach(u=>this[u]=c[u]),i=c},set flatShading(a){const c=te(a);c!==this.flatShading&&(i.flatShading=c,this.propList.includes("flatShading")&&this.list.forEach(u=>{u.flatShading=c,u.needsUpdate=!0}))},set gradientMap(a){var p,f;if(a===this.gradientMap||(i.gradientMap=a,!this.propList.includes("gradientMap")))return;const c=(p=this.list[0])==null?void 0:p.gradientMap;(f=c==null?void 0:c.dispose)==null||f.call(c);const u=a==="none"?null:$n(a);this.list.forEach(h=>{h.gradientMap=u,h.needsUpdate=!0})},set showTexture(a){const c=te(a);if(this.showTexture===c)return;i.showTexture=c;const u=c?p=>{p.map=p.userData.backupMap,p.userData.backupMap=null,p.needsUpdate=!0}:p=>{p.userData.backupMap=p.map,p.map=null,p.needsUpdate=!0};this.list.forEach(u)},set matcap(a){var p,f;if(i.matcap===a||(i.matcap=a,!this.propList.includes("matcap")))return;const c=(p=this.list[0])==null?void 0:p.matcap;(f=c==null?void 0:c.dispose)==null||f.call(c);const u=Hn(a);this.list.forEach(h=>{h.matcap=u,h.needsUpdate=!0})}};return Jr.forEach(a=>Object.defineProperty(l,a,{get(){return i[a]},...!Vn.includes(a)&&{set(c){c!==this[a]&&(i[a]=c,this.propList.includes(a)&&this.list.forEach(u=>u[a]=ri[a](c)))}}})),lt(s).forEach(a=>l[a]=t[a]),i={...ue,...i},e.material=Ye(l),e},ki=`uniform float opacity;\r
uniform vec3 color;\r
\r
void main() {\r
	gl_FragColor = vec4( color, opacity );\r
}\r
`,Fi=`uniform float size;\r
\r
#include <skinning_pars_vertex>\r
\r
void main() {\r
	#include <skinbase_vertex>\r
	\r
    vec3 transformed = position + normal * 0.0005 * size;\r
        \r
	#include <skinning_vertex>\r
	#include <project_vertex>\r
}`,Ri=r=>new bt({side:_s,transparent:!0,depthFunc:Bs,vertexShader:Fi,fragmentShader:ki,uniforms:r});function _i(r,e){const{material:n}=r,t=Array.isArray(r.material);[n].flat().forEach(Gr),r.material=t?new Array(r.material.length).fill(e):e}function Bi(r,e){const n=Ri(e),t=[],s=["Eff","Extension"];return r.forEach(i=>{const{name:o}=i;if(s.some(a=>o.includes(a)))return;const l=i.clone();l.name=`outline-${i.name}`,_i(l,n),i.isSkinnedMesh&&l.bind(i.skeleton,i.bindMatrix),i.add(l),t.push(l)}),t}const ji={size:parseFloat,opacity:parseFloat,color:Ve},Ui=r=>e=>{const n={...we,...r},t=e.meshes,s={size:{value:n.size},opacity:{value:n.opacity},color:{value:new R(n.color)}},i=Bi(t,s),o={...n,enabled:!0},l={get propList(){return["enabled","color","size","opacity"]},get enabled(){return o.enabled},set enabled(a){const c=te(a);i.forEach(u=>u.visible=c),o.enabled=c},get code(){if(!this.enabled)return"none";const a=[];return Object.keys(we).forEach(c=>{const u=this[c];u!==we[c]&&a.push(`${c}=${u}`)}),a.join("/").replaceAll("#","")},set code(a){if(a==="none"){this.enabled=!1;return}const c=Object.keys(we),u={...we,...zn(a)};c.forEach(p=>{this[p]=u[p]})},toString(){const{code:a}=this;return a?`ol=(${a})`:""}};return["size","opacity","color"].forEach(a=>Object.defineProperty(l,a,{get(){return o[a]},set(c){c!==this[a]&&(o[a]=c,s[a].value=ji[a](c))}})),l.enabled=n.enabled,e.outline=Ye(l),e},zi=["push","pop","shift","unshift","splice","reverse","sort"];class pe extends Array{constructor(...e){super(...e),Object.assign(this,Oe),zi.forEach(n=>{Object.defineProperty(this,n,{value:(...t)=>{Array.prototype[n].call(this,...t),this.dispatchEvent({type:"change",method:n,args:t})},enumerable:!1})})}remove(e){const n=this.indexOf(e);n!==-1&&this.splice(n,1)}}const rn={chainName:"",chainCode:"",chainLength:0,aniIdx:0,clipDuration:0,clipTimeScale:1,action:null,aniAction:[],aniActionPointer:0};function Ni(r){return r.split(">").map(Vi)}function Vi(r){const[e,...n]=r.split("&"),t=$i(n);return{aniName:e,...t}}function $i(r){const e={},n=[],t={r:{name:"reps",map:parseInt},ts:{name:"timeScale",map:parseFloat},dur:{name:"duration",map:Hi}};return r.forEach(s=>{const[i,o]=jn(s);if(i.startsWith("@")){const c=Gi(o.replace(/[()]/g,""));c.time=parseFloat(i.slice(1)),n.push(c);return}if(!t[i])return;const{name:l,map:a}=t[i];e[l]=a(o)}),e.aniAction=n.filter(({time:s})=>s<=100&&s>=0).sort((s,i)=>s.time-i.time),e}function Hi(r){if(!r)return[0,100];const e=r.split("-").slice(0,2).map(parseFloat),n=e.length===2?e:[0,e[0]];return n.some(t=>t>100||t<0)||n[0]>n[1]?[0,100]:n}function Gi(r){return r.split("/").reduce((n,t)=>{const[s,i]=jn(t);return{...n,...Xi(s,i)}},{})}const an={ei:{name:"face.eyeIdx",valueMap:parseInt},mi:{name:"face.mouthIdx",valueMap:parseInt},et:{name:"face.eyeTexture"},mt:{name:"face.mouthTexture"}};function Xi(r,e){if(r in an){const{name:s,valueMap:i}=an[r];return{[s]:(i==null?void 0:i(e))??e}}let n=r,t=e;return r.startsWith("att")&&n.replace("att","attachment"),r.startsWith("parts")&&(n+="index",t=parseInt(e)),{[n]:t}}const Wi=r=>`${Pn}/${r}.json`;function Yi(r,e){if(r.startsWith("fbx:"))return Ki(r);if(r.startsWith("ex:")){const[,t]=r.split(":"),s=e==null?void 0:e.find(({uuid:i})=>t===i);return Promise.resolve(s.clone())}const n=Wi(r);return new Promise(t=>fetch(n).then(s=>s.json()).then(s=>yn.parse(s)).then(t))}async function Ki(r){const e=r.replace("fbx:",""),[n,t]=e.split("+"),{animations:s}=await Rn(n);return t?s.find(({name:i})=>i===t):s[0]}function Zi(r,e=null){return Promise.all(r.map(n=>Yi(n,e)))}function qi(r,e=[]){return r.map((n,t)=>{const s=e[t];if(!s||s[0]===0&&s[1]===100)return n;const i=n.duration*mt,[o,l]=s.map(a=>Math.round(a*i/100));return js.subclip(n,n.name,o,l,mt)})}async function Qi(r,e=null){const n=Ni(r),t=n.map(({aniName:c})=>c),s=n.map(({duration:c})=>c),i=n.map(({aniName:c,duration:u,...p})=>({...p})),o=await Zi(t,e),l=qi(o,s);return{code:r,clips:l,mod:i,get duration(){return i.some(({timeScale:u})=>u===0)?1/0:l.map((u,p)=>u.duration/Math.abs(i[p].timeScale??1)*(i[p].reps??1)).reduce((u,p)=>u+p,0)}}}const Ji=/[a-z][0-9]{6}/;function ea(r){const{model:e,uniqueId:n,bones:t,id:s,viewer:i}=r,o=i.userData.ani,l=new Us(e),a=(t==null?void 0:t.list)??[],c={...Oe,mixer:l,chain:{},current:{...rn},toString(){var f;const p=(f=this.chain.default)==null?void 0:f.code;return p?`ani=${p}`:""},async addChain(p,{name:f="default",autoplay:h=!0}={}){var y;if(!p||((y=this.chain[f])==null?void 0:y.code)===p)return;l.stopAllAction();const m=await Qi(p,o);m.clips.forEach(v=>{v.tracks=v.tracks.reduce((w,b)=>{let g=b.name.split(".")[0];return Ji.test(g)&&(b.name.replace(g,s),g=s),a.includes(g)&&(b.name=`${n}|${b.name}`,w.push(b)),w},[])}),this.chain[f]=m,l.addEventListener("finished",u),h&&this.play(f)},play(p=this.current.chainName||"default"){const f=this.chain[p];f&&(this.current.chainName=p,this.current.chainCode=f.code,this.current.chainLength=f.clips.length,this.aniIdx=0)},pause(){this.current.action&&(this.current.action.paused=!0)},resume(){this.current.action&&(this.current.action.paused=!1)},stop(){l.stopAllAction()},reset(){const p=this.current.chainName;this.stop(),this.current={...rn},this.chain[p]=void 0},update(p){var v;l.update(p);const{current:f}=this,{action:h,aniAction:m,clipDuration:y}=f;if(!(!m[f.aniActionPointer]||!h))for(;(h==null?void 0:h.time)>((v=m[f.aniActionPointer])==null?void 0:v.time)*y/100;)this.applyAniAction(m[f.aniActionPointer]),this.current.aniActionPointer++},applyAniAction(p){r.dispatchEvent({type:"aniAction",id:n,aniAction:p});const{time:f,...h}=p;Object.entries(h).forEach(([m,y])=>{const v=m.split(".");Bn(r,v,y)})},nextFrame(p=1,f=mt){if(!this.isPaused)return;const{clipTimeScale:h,clipDuration:m,action:y}=this.current,v=p*h/f;if(y.time+=v,y.time>=m){const w=y.time-m;u(),this.pause(),this.current.action.time+=w*this.current.clipTimeScale}},setTime(p){const{clipDuration:f,action:h}=this.current;!f||p>f||(h.time=p)},get isPaused(){var p;return(p=this.current.action)==null?void 0:p.paused},get aniIdx(){return this.current.aniIdx},set aniIdx(p){if(p>=this.current.chainLength)return;this.current.aniIdx=p,this.current.aniActionPointer=0;const f={type:p===0?"chainStart":"chainMove",index:p,uniqueId:n,chainName:this.current.chainName};this.dispatchEvent(f),l.stopAllAction();const h=this.chain[this.current.chainName],m=h.mod[p],{timeScale:y,reps:v,aniAction:w}=m,b=h.clips[p],g=l.clipAction(b);g.timeScale=y??1,g.setLoop(zs,v??1),this.current.clipDuration=b.duration,this.current.action=g,this.current.aniAction=w,this.current.aniActionPointer=0,this.current.clipTimeScale=y??1,g.play()}};function u(){const{aniIdx:p,chainLength:f}=c.current,h=(p+1)%f;if(h===0){c.dispatchEvent({type:"ChainFinished",chainName:c.current.chainName});const{face:m}=r;m&&(m.eyeIdx=m.eyeBaseIdx,m.mouthIdx=m.mouthBaseIdx)}c.aniIdx=h}return r.animation=c,r.addEventListener("TimeUpdated",({dt:p})=>c.update(p)),r}function ta(r){const{model:e,bones:n,uniqueId:t}=r,s={};return Object.defineProperty(s,"list",{get(){return Object.values(this).flat()}}),Object.defineProperty(s,"traverse",{value:function(u){this.list.forEach(p=>{var f,h;u(p),(h=(f=p.attachment)==null?void 0:f.traverse)==null||h.call(f,u)})}}),Object.assign(r,{attachment:s,parent:null,parentBone:"",attach:(u,p="root")=>{s[p]=s[p]??new pe;const f=p==="root"?e:n.find(({name:h})=>h===`${t}|${p}`);f!=null&&f.add&&(u.detach(),f.add(u.model),s[p].push(u),u.parent=r,u.parentBone=p,r.dispatchEvent({type:"AttachmentChanged"}))},remove:(u,p="")=>{var h,m,y;const f=p||Object.keys(s).find(v=>s[v].indexOf(u)!==-1);f&&((m=(h=s[f]).remove)==null||m.call(h,u),(y=u.model.parent)==null||y.remove(u.model),r.dispatchEvent({type:"AttachmentChanged"}))},detach:()=>{var f;(f=e.parent)==null||f.remove(e);const{parent:u,parentBone:p}=r;u&&(u.remove(r,p),r.parent=r.parentBone=null)},attachTo:(u,p="root")=>{var f;r.detach(),(f=u==null?void 0:u.attach)==null||f.call(u,r,p)}})}function na(r){const{material:e,id:n}=r,t=Ie.source.fbx,s=on(n);zr(n)&&async function(){const a=l(s),c=new xe().load(a);c.encoding=G,c.name=s,e.list.forEach(u=>u.map=u.map??c)}();let i=s;Object.defineProperty(r,"texture",{get(){return i},set(a){if(!a){this.texture=s;return}if(a===i)return;const c=l(a),[,u]=o(a),[,p]=o(this.texture),f=e.list.filter(h=>{var m,y,v,w;return((y=(m=h.map)==null?void 0:m.name)==null?void 0:y.includes(p))||((w=(v=h.userData.backupMap)==null?void 0:v.name)==null?void 0:w.includes(p))});f.length&&(async function(){const h=await _n(c);h.name=u,h.encoding=G,f.forEach(m=>{var y,v,w,b;m.map&&((v=(y=m.map).dispose)==null||v.call(y),m.map=h),m.userData.backupMap&&((b=(w=m.userData.backupMap).dispose)==null||b.call(w),m.userData.backupMap=h)})}(),i=a)}});function o(a){const[c,u]=a.split(">"),p=c||n,f=u||on(p);return[p,f]}function l(a){const[c,u]=o(a);return`${t}/${c}/${u}.png`}return r}const on=r=>r.match(/_[0-9]{2}/)||r.startsWith("h")?r:`>${r}_01`,sa=`uniform float uTime;\r
uniform float uSpread;\r
uniform float uThreshold;\r
uniform float uSpeed;\r
uniform float uParticleSize;\r
uniform float uAuraSize;\r
\r
attribute float aRandom;\r
\r
varying float vIsParticle;\r
varying float vRandom;\r
\r
#include <skinning_pars_vertex>\r
void main() {\r
    #include <skinbase_vertex>\r
\r
    vec3 transformed = position + normal * 0.005 * uSpread;\r
\r
    #include <skinning_vertex>\r
\r
    vec3 objectNormal = normal;\r
\r
	#include <skinnormal_vertex>\r
    \r
    vec4 viewPosition = viewMatrix * modelMatrix * vec4(transformed, 1.0);\r
    float yDisplacement = fract( uTime * uSpeed + aRandom ) * 0.1;\r
    viewPosition.y += yDisplacement;\r
    viewPosition.x += sin( uTime * aRandom * uSpeed + aRandom ) * 0.02;\r
    \r
    gl_Position = projectionMatrix * viewPosition;\r
    \r
    objectNormal.z *= objectNormal.z > 0.7 ? -1.0 : 1.0;\r
    vIsParticle = objectNormal.z - uThreshold;\r
\r
    gl_PointSize = vIsParticle > 0.0 ? uParticleSize : uAuraSize;\r
    gl_PointSize /= -viewPosition.z;\r
\r
    vRandom = aRandom;\r
}\r
`,ra=`uniform sampler2D uTexture;\r
\r
uniform float uTime;\r
uniform float uParticleOpacity;\r
uniform float uAuraOpacity;\r
uniform vec3 uColor;\r
uniform vec3 uColor2;\r
\r
varying float vRandom;\r
varying float vIsParticle;\r
\r
void main(){\r
    vec4 textureColor = texture2D( uTexture, gl_PointCoord );\r
    textureColor.a = length( textureColor.rgb ) ;\r
    textureColor.a *= abs( 1.0 - fract( uTime + vRandom ) ) * 0.5;\r
    textureColor.rgb = mix( uColor, uColor2,  textureColor.a * 2.0 );\r
    textureColor.a *= vIsParticle > 0.0 ? uParticleOpacity * 4.0 : uAuraOpacity;\r
\r
    gl_FragColor = textureColor;\r
    gl_FragColor /= vIsParticle > 0.0 ? 2.0 : 4.0;\r
}\r
`,$e=[{name:"time",uName:"uTime",defaultValue:0,valueMap:Number},{name:"speed",uName:"uSpeed",defaultValue:1,valueMap:Number},{name:"particleOpacity",uName:"uParticleOpacity",defaultValue:.3,valueMap:Number},{name:"auraOpacity",uName:"uAuraOpacity",defaultValue:.3,valueMap:Number},{name:"particleSize",uName:"uParticleSize",defaultValue:10,valueMap:Number},{name:"auraSize",uName:"uAuraSize",defaultValue:100,valueMap:Number},{name:"spread",uName:"uSpread",defaultValue:5,valueMap:Number},{name:"threshold",uName:"uThreshold",defaultValue:.3,valueMap:Number},{name:"texture",uName:"uTexture",defaultValue:"img/textures/particle/cloud.png",valueMap:r=>new xe().load(r)},{name:"color",uName:"uColor",defaultValue:"#ffffff",valueMap:r=>new R(r)},{name:"color2",uName:"uColor2",defaultValue:"#33ffff",valueMap:r=>new R(r)}],ia={aura:["visible",...$e.slice(1).map(({name:r})=>r)]},aa=(r="aura")=>(e,n={})=>{if(e!=null&&e.length&&r==="aura")return ca(e,n)};function oa(r){return new bt({vertexShader:sa,fragmentShader:ra,uniforms:r,transparent:!0,blending:$s,depthWrite:!1,side:Hs})}function ca(r,e){const n=$e.map(a=>{const{uName:c,defaultValue:u,valueMap:p}=a,f=(p==null?void 0:p(u))??u;return[c,{value:f}]}),t=Object.fromEntries(n),s=oa(t),i=[];r.forEach(a=>{const{name:c}=a.geometry;if(c.startsWith("mEye")||c.startsWith("mMouth"))return;const u=a.geometry.clone(),p=u.attributes.position.count,f=new Float32Array(p).fill(0).map(()=>Math.random()-.5);u.setAttribute("aRandom",new Ns(f,1)),u.deleteAttribute("color"),u.deleteAttribute("uv");const h=new Vs(u,s);h.name="aura",a.isSkinnedMesh&&(h.type="SkinnedMesh",h.isSkinnedMesh=!0,h.skeleton=a.skeleton,h.bindMatrix=a.bindMatrix,h.bindMatrixInverse=a.bindMatrixInverse,h.bindMode=a.bindMode,h.bind=a.bind,h.clone=a.clone,h.initBones=a.initBones,h.normalizeSkinWeights=a.normalizeSkinWeights,h.pose=a.pose,h.updateMatrixWorld=a.updateMatrixWorld),a.add(h),i.push(h)});const o={visible:!0},l={name:"aura",onDispose:()=>{},get list(){return i},get propList(){return ia.aura},get visible(){return o.visible},set visible(a){const c=te(a);this.list.forEach(u=>u.visible=c),o.visible=c},dispose(){this.onDispose(),this.list.forEach(a=>{var c,u,p,f,h;(c=a.parent)==null||c.remove(a),(p=(u=a.material).dispose)==null||p.call(u),(h=(f=a.geometry).dispose)==null||h.call(f)})},set code(a){a.split("/").forEach(u=>{const[p,f]=u.split("=");$e.map(({name:h})=>h).includes(p)&&(this[p]=f)})}};return $e.forEach(a=>{const{name:c,uName:u,defaultValue:p,valueMap:f}=a;o[c]=p,Object.defineProperty(l,c,{get(){return o[c]},set(h){o[c]=h,t[u].value=(f==null?void 0:f(h))??h}})}),l.onTimeUpdate=({time:a})=>l.time=a,Object.entries(e).forEach(([a,c])=>l[a]=c),l}function la(r){const{meshes:e}=r,n={list:new pe,dispose(){this.list.forEach(t=>{var s;return(s=t.dispose)==null?void 0:s.call(t)})},add(t="aura",s={}){const i=aa(t)(e,s);return i.onDispose=()=>this.list.remove(i),this.list.push(i),r.addEventListener("TimeUpdated",i.onTimeUpdate),i}};return r.particle=n,r}const ua=r=>{var l,a;if(r.dispatchEvent({type:"dispose"}),!r)return;const{model:e,meshes:n,outline:t,particle:s,viewer:i}=r;s==null||s.list.forEach(c=>c.dispose()),(l=e.parent)!=null&&l.isScene&&(e.parent.remove(e),i.loadedModel.remove(r)),(a=r.detach)==null||a.call(r),[n.reverse(),t==null?void 0:t.all].flat().forEach(Wr)};function pa(r){const{x:e,y:n,z:t}=r;return[e,n,t].map(s=>s||"").join()}const fa={position:",,",rotation:",,",scale:"1,1,1"},ha={position:"pos",rotation:"rot",scale:"scl"};function da(r){return Object.assign(r,{...r.isDLModel&&{toString(){const{id:e,animation:n,outline:t,material:s}=this,i=Object.entries(fa).map(([o,l])=>{const a=pa(this[o]);return a===l?"":`${ha[o]}=${a}`});return[`id=${e}`,...i,n,t,s].filter(o=>`${o}`).join("/")}},dispose(){const{attachment:e,parent:n,parentBone:t}=this;e.list.forEach(s=>s.dispose()),n==null||n.remove(this,t),this.dispatchEvent({type:"dispose"}),ua(this)}})}let Zn=(r=21)=>crypto.getRandomValues(new Uint8Array(r)).reduce((e,n)=>(n&=63,n<36?e+=n.toString(36):n<62?e+=(n-26).toString(36).toUpperCase():n>62?e+="-":e+="_",e),"");function ma(r,e){const{id:n,material:t,outline:s,viewer:i}=e,o=[Li,Di,ta,Ui(s),Oi(t),na,Pi,ea,la,da],l={...Oe,isDLModel:!0,model:r,id:n,uniqueId:Zn(),type:Nr(n),viewer:i,userData:{},_time:0,update(a){var c;this._time+=a,(c=this.attachment)==null||c.list.forEach(u=>{var p;return(p=u.update)==null?void 0:p.call(u,a)}),this.dispatchEvent({type:"TimeUpdated",dt:a,time:this._time})},set scale(a){var u;if((u=a.includes)!=null&&u.call(a,",")){const[p,f,h]=a.split(",").map(m=>m?parseFloat(m):1);this.model.scale.set(p,f,h);return}const c=Number(a)||1;this.model.scale.set(c,c,c)},get scale(){const{scale:a}=this.model,{x:c,y:u,z:p}=a;return c===u&&c===p?c:[c,u,p].join(",")},set visible(a){this.model.visible=te(a)}};return["position","rotation","visible"].forEach(a=>Object.defineProperty(l,a,{get(){return this.model[a]},enumerable:!0})),r.userData.container=l,Br(...o)(l)}class cn extends xt{constructor(e,n){super(),this.scene=e,this.camera=n,this.clear=!0,this.needsSwap=!1,this.inverse=!1}render(e,n,t){const s=e.getContext(),i=e.state;i.buffers.color.setMask(!1),i.buffers.depth.setMask(!1),i.buffers.color.setLocked(!0),i.buffers.depth.setLocked(!0);let o,l;this.inverse?(o=0,l=1):(o=1,l=0),i.buffers.stencil.setTest(!0),i.buffers.stencil.setOp(s.REPLACE,s.REPLACE,s.REPLACE),i.buffers.stencil.setFunc(s.ALWAYS,o,4294967295),i.buffers.stencil.setClear(l),i.buffers.stencil.setLocked(!0),e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera),e.setRenderTarget(n),this.clear&&e.clear(),e.render(this.scene,this.camera),i.buffers.color.setLocked(!1),i.buffers.depth.setLocked(!1),i.buffers.stencil.setLocked(!1),i.buffers.stencil.setFunc(s.EQUAL,1,4294967295),i.buffers.stencil.setOp(s.KEEP,s.KEEP,s.KEEP),i.buffers.stencil.setLocked(!0)}}class ga extends xt{constructor(){super(),this.needsSwap=!1}render(e){e.state.buffers.stencil.setLocked(!1),e.state.buffers.stencil.setTest(!1)}}class ya{constructor(e,n){if(this.renderer=e,n===void 0){const t=e.getSize(new k);this._pixelRatio=e.getPixelRatio(),this._width=t.width,this._height=t.height,n=new bn(this._width*this._pixelRatio,this._height*this._pixelRatio),n.texture.name="EffectComposer.rt1"}else this._pixelRatio=1,this._width=n.width,this._height=n.height;this.renderTarget1=n,this.renderTarget2=n.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,this.passes=[],this.copyPass=new Zs(Ks),this.clock=new xn}swapBuffers(){const e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e}addPass(e){this.passes.push(e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}insertPass(e,n){this.passes.splice(n,0,e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}removePass(e){const n=this.passes.indexOf(e);n!==-1&&this.passes.splice(n,1)}isLastEnabledPass(e){for(let n=e+1;n<this.passes.length;n++)if(this.passes[n].enabled)return!1;return!0}render(e){e===void 0&&(e=this.clock.getDelta());const n=this.renderer.getRenderTarget();let t=!1;for(let s=0,i=this.passes.length;s<i;s++){const o=this.passes[s];if(o.enabled!==!1){if(o.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(s),o.render(this.renderer,this.writeBuffer,this.readBuffer,e,t),o.needsSwap){if(t){const l=this.renderer.getContext(),a=this.renderer.state.buffers.stencil;a.setFunc(l.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),a.setFunc(l.EQUAL,1,4294967295)}this.swapBuffers()}cn!==void 0&&(o instanceof cn?t=!0:o instanceof ga&&(t=!1))}}this.renderer.setRenderTarget(n)}reset(e){if(e===void 0){const n=this.renderer.getSize(new k);this._pixelRatio=this.renderer.getPixelRatio(),this._width=n.width,this._height=n.height,e=this.renderTarget1.clone(),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2}setSize(e,n){this._width=e,this._height=n;const t=this._width*this._pixelRatio,s=this._height*this._pixelRatio;this.renderTarget1.setSize(t,s),this.renderTarget2.setSize(t,s);for(let i=0;i<this.passes.length;i++)this.passes[i].setSize(t,s)}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}dispose(){this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.copyPass.dispose()}}class va extends xt{constructor(e,n,t,s,i){super(),this.scene=e,this.camera=n,this.overrideMaterial=t,this.clearColor=s,this.clearAlpha=i!==void 0?i:0,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1,this._oldClearColor=new R}render(e,n,t){const s=e.autoClear;e.autoClear=!1;let i,o;this.overrideMaterial!==void 0&&(o=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),this.clearColor&&(e.getClearColor(this._oldClearColor),i=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),this.clearDepth&&e.clearDepth(),e.setRenderTarget(this.renderToScreen?null:t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),e.render(this.scene,this.camera),this.clearColor&&e.setClearColor(this._oldClearColor,i),this.overrideMaterial!==void 0&&(this.scene.overrideMaterial=o),e.autoClear=s}}function ln({renderer:r,scene:e,camera:n}){const t=wa(),s=new ya(r,t),i=new va(e,n);return s.addPass(i),s}const wa=()=>new bn(800,600,{minFilter:Gt,magFilter:Gt,format:Gs,encoding:G}),pt={bloom:xa,pixel:Pa,afterimage:Sa,sobel:Ta,halftone:Aa,dotscreen:Ma,bokeh:La,smaa:Ea};async function ba(r,e){var t;r=r.toLowerCase();const n=await((t=pt[r])==null?void 0:t.call(pt,e));return n.type=r,n.name=Tt[r].name,n}function Ke(r,e){Object.defineProperty(r,"propList",{value:e}),e.forEach(n=>{Object.defineProperty(r,n,{get(){return this.uniforms[n].value},set(t){this.uniforms[n].value=t}})})}async function xa({resolution:r=new k(800,600),strength:e=.3,radius:n=.5,threshold:t=.8}={}){const{UnrealBloomPass:s}=await Z(()=>import("./64fe4291-UnrealBloomPass.js"),["assets/64fe4291-UnrealBloomPass.js","assets/422fb203-three.js","assets/c51705f5-Pass.js","assets/e27bbfcf-CopyShader.js"]),i=new s(r,e,n,t);return Object.defineProperty(i,"propList",{value:["radius","strength","threshold"],writable:!1}),i}async function Ea({renderer:r}){const{SMAAPass:e}=await Z(()=>import("./187782b7-SMAAPass.js"),["assets/187782b7-SMAAPass.js","assets/422fb203-three.js","assets/c51705f5-Pass.js"]),n=new k;r.getSize(n);const t=new e(n.x,n.y);return Object.defineProperty(t,"propList",{value:[],writable:!1}),t}async function Pa({scene:r,camera:e}){const{RenderPixelatedPass:n}=await Z(()=>import("./a3d19220-RenderPixelatedPass.js"),["assets/a3d19220-RenderPixelatedPass.js","assets/422fb203-three.js","assets/c51705f5-Pass.js"]),t=new n(5,r,e);return Object.defineProperty(t,"propList",{value:["size"],writable:!1}),Object.defineProperty(t,"size",{get(){return this.pixelSize},set(s){this.setPixelSize(s)}}),t}async function Ta({renderer:r}){const{ShaderPass:e}=await Z(()=>import("./717175ec-ShaderPass.js"),["assets/717175ec-ShaderPass.js","assets/422fb203-three.js","assets/c51705f5-Pass.js"]),{SobelOperatorShader:n}=await Z(()=>import("./0e12e7da-SobelOperatorShader.js"),["assets/0e12e7da-SobelOperatorShader.js","assets/422fb203-three.js"]),t=new k;r.getSize(t),t.multiplyScalar(window.devicePixelRatio);const s=new e(n);return s.uniforms.resolution.value.x=t.x,s.uniforms.resolution.value.y=t.y,Object.defineProperty(s,"propList",{value:[],writable:!1}),s}async function Aa({renderer:r}){const{HalftonePass:e}=await Z(()=>import("./dd1cdd1f-HalftonePass.js"),["assets/dd1cdd1f-HalftonePass.js","assets/422fb203-three.js","assets/c51705f5-Pass.js"]),n=new k;r.getSize(n);const t=new e(n.x,n.y,{radius:4});return Ke(t,["greyscale","radius","scatter","shape"]),t}async function Ma(){const{DotScreenPass:r}=await Z(()=>import("./1ec95f1b-DotScreenPass.js"),["assets/1ec95f1b-DotScreenPass.js","assets/422fb203-three.js","assets/c51705f5-Pass.js"]),e=new r;return Ke(e,["scale","center"]),e}async function La({scene:r,camera:e}){const{BokehPass:n}=await Z(()=>import("./0026b360-BokehPass.js"),["assets/0026b360-BokehPass.js","assets/422fb203-three.js","assets/c51705f5-Pass.js"]),t=new n(r,e,{});return Ke(t,["focus","aperture","aspect"]),t}async function Sa(){const{AfterimagePass:r}=await Z(()=>import("./641232ce-AfterimagePass.js"),["assets/641232ce-AfterimagePass.js","assets/422fb203-three.js","assets/c51705f5-Pass.js"]),e=new r(.7);return Ke(e,["damp"]),e}function Ia(r){const{name:e,type:n}=r,t=Tt[n].propList??[],s={};return t.forEach(o=>{Object.defineProperty(s,o,{get(){return r[o]},set(l){r[o]=l},enumerable:!0})}),{target:r,name:e,type:n,params:s,id:Zn()}}const Tt={bloom:{name:"Bloom",propList:["enabled","radius","strength","threshold"]},pixel:{name:"Pixelate",propList:["enabled","size"]},afterimage:{name:"Afterimage",propList:["enabled","damp"]},sobel:{name:"Sobel",propList:["enabled"]},halftone:{name:"Halftone",propList:["enabled","greyscale","radius","scatter","shape"]},dotscreen:{name:"Dot Screen",propList:["enabled","scale"]},bokeh:{name:"Bokeh",propList:["enabled","focus","aperture","aspect"]},smaa:{name:"SMAA",propList:["enabled"]}};Object.entries(Tt).map(([r,{name:e}])=>({value:r,label:e}));var vt={},Ca={get exports(){return vt},set exports(r){vt=r}};(function(r,e){(function(n,t){r.exports=t()})(ve,function(){var n=function(){function t(h){return o.appendChild(h.dom),h}function s(h){for(var m=0;m<o.children.length;m++)o.children[m].style.display=m===h?"block":"none";i=h}var i=0,o=document.createElement("div");o.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",o.addEventListener("click",function(h){h.preventDefault(),s(++i%o.children.length)},!1);var l=(performance||Date).now(),a=l,c=0,u=t(new n.Panel("FPS","#0ff","#002")),p=t(new n.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var f=t(new n.Panel("MB","#f08","#201"));return s(0),{REVISION:16,dom:o,addPanel:t,showPanel:s,begin:function(){l=(performance||Date).now()},end:function(){c++;var h=(performance||Date).now();if(p.update(h-l,200),h>a+1e3&&(u.update(1e3*c/(h-a),100),a=h,c=0,f)){var m=performance.memory;f.update(m.usedJSHeapSize/1048576,m.jsHeapSizeLimit/1048576)}return h},update:function(){l=this.end()},domElement:o,setMode:s}};return n.Panel=function(t,s,i){var o=1/0,l=0,a=Math.round,c=a(window.devicePixelRatio||1),u=80*c,p=48*c,f=3*c,h=2*c,m=3*c,y=15*c,v=74*c,w=30*c,b=document.createElement("canvas");b.width=u,b.height=p,b.style.cssText="width:80px;height:48px";var g=b.getContext("2d");return g.font="bold "+9*c+"px Helvetica,Arial,sans-serif",g.textBaseline="top",g.fillStyle=i,g.fillRect(0,0,u,p),g.fillStyle=s,g.fillText(t,f,h),g.fillRect(m,y,v,w),g.fillStyle=i,g.globalAlpha=.9,g.fillRect(m,y,v,w),{dom:b,update:function(P,x){o=Math.min(o,P),l=Math.max(l,P),g.fillStyle=i,g.globalAlpha=1,g.fillRect(0,0,u,y),g.fillStyle=s,g.fillText(a(P)+" "+t+" ("+a(o)+"-"+a(l)+")",f,h),g.drawImage(b,m+c,y,v-c,w,m,y,v-c,w),g.fillRect(m+v-c,y,c,w),g.fillStyle=i,g.globalAlpha=.9,g.fillRect(m+v-c,y,c,a((1-P/x)*w))}}},n})})(Ca);var Ce={},Da={get exports(){return Ce},set exports(r){Ce=r}};(function(r,e){(function(n,t){t()})(ve,function(){function n(c,u){return typeof u>"u"?u={autoBom:!1}:typeof u!="object"&&(console.warn("Deprecated: Expected third argument to be a object"),u={autoBom:!u}),u.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(c.type)?new Blob(["\uFEFF",c],{type:c.type}):c}function t(c,u,p){var f=new XMLHttpRequest;f.open("GET",c),f.responseType="blob",f.onload=function(){a(f.response,u,p)},f.onerror=function(){console.error("could not download file")},f.send()}function s(c){var u=new XMLHttpRequest;u.open("HEAD",c,!1);try{u.send()}catch{}return 200<=u.status&&299>=u.status}function i(c){try{c.dispatchEvent(new MouseEvent("click"))}catch{var u=document.createEvent("MouseEvents");u.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),c.dispatchEvent(u)}}var o=typeof window=="object"&&window.window===window?window:typeof self=="object"&&self.self===self?self:typeof ve=="object"&&ve.global===ve?ve:void 0,l=o.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),a=o.saveAs||(typeof window!="object"||window!==o?function(){}:"download"in HTMLAnchorElement.prototype&&!l?function(c,u,p){var f=o.URL||o.webkitURL,h=document.createElement("a");u=u||c.name||"download",h.download=u,h.rel="noopener",typeof c=="string"?(h.href=c,h.origin===location.origin?i(h):s(h.href)?t(c,u,p):i(h,h.target="_blank")):(h.href=f.createObjectURL(c),setTimeout(function(){f.revokeObjectURL(h.href)},4e4),setTimeout(function(){i(h)},0))}:"msSaveOrOpenBlob"in navigator?function(c,u,p){if(u=u||c.name||"download",typeof c!="string")navigator.msSaveOrOpenBlob(n(c,p),u);else if(s(c))t(c,u,p);else{var f=document.createElement("a");f.href=c,f.target="_blank",setTimeout(function(){i(f)})}}:function(c,u,p,f){if(f=f||open("","_blank"),f&&(f.document.title=f.document.body.innerText="downloading..."),typeof c=="string")return t(c,u,p);var h=c.type==="application/octet-stream",m=/constructor/i.test(o.HTMLElement)||o.safari,y=/CriOS\/[\d]+/.test(navigator.userAgent);if((y||h&&m||l)&&typeof FileReader<"u"){var v=new FileReader;v.onloadend=function(){var g=v.result;g=y?g:g.replace(/^data:[^;]*;/,"data:attachment/file;"),f?f.location.href=g:location=g,f=null},v.readAsDataURL(c)}else{var w=o.URL||o.webkitURL,b=w.createObjectURL(c);f?f.location=b:location.href=b,f=null,setTimeout(function(){w.revokeObjectURL(b)},4e4)}});o.saveAs=a.saveAs=a,r.exports=a})})(Da);const Oa=["video/mp4;codecs=h264","video/webm;codecs=h264","video/webm;codecs=vp9","video/webm;codecs=vp8","video/webm"],ze=Oa.filter(MediaRecorder.isTypeSupported);function ka(r){if(!ze.length)return;const e=[],n=ze[0],t={settings:{...di,mimeType:n},get supportedMimeTypes(){return ze},get mimeType(){return this.settings.mimeType},set mimeType(s){ze.includes(s)&&(this.settings.mimeType=s)},start(){if(this.recorder)return;const{fileName:s,frameRate:i,mimeType:o}=this.settings,l=r.captureStream(i||30),a=l.getTracks()[0],c=new MediaRecorder(l,{mimeType:o});c.onstart=()=>e.length=0,c.ondataavailable=({data:u})=>e.push(u),c.onstop=()=>{a.stop(),this.recorder=void 0;const u=this.settings.mimeType.includes("webm")?"webm":"mp4",p=new Blob(e,{type:`video/${u}`}),f=this.settings.appendDate?`_${Yr()}`:"",h=`${s||"ani"}${f}.${u}`;Ce.saveAs(p,h)},c.start(),this.recorder=c},get state(){var s;return((s=this.recorder)==null?void 0:s.state)??"idle"}};return["pause","resume","stop"].forEach(s=>{Object.defineProperty(t,s,{value:()=>{var i;return(i=t.recorder)==null?void 0:i[s]()}})}),t}function Fa(r){let e=1,n=!1,t=!1;const s=()=>{r.stats.begin(),r.controls.update();const c=n?-e:e,u=r.clock.getDelta()*c;t||r.update(u),r.render(),r.stats.end()};let i=!1;const o=()=>{i||(r.render(),i=!0,setTimeout(()=>i=!1,50))};let l="";return{start(){l!=="active"&&(r.renderer.setAnimationLoop(s),r.controls.removeEventListener("change",o),l="active")},stop(){l!=="inactive"&&(r.renderer.setAnimationLoop(null),r.controls.addEventListener("change",o),l="inactive")},pause(){t=!0},resume(){t=!1},get state(){return l},get timeScale(){return e},set timeScale(c){const u=parseFloat(c);e=isNaN(u)?1:Math.abs(u)},get reverse(){return n},set reverse(c){n=!!c},get paused(){return t},set paused(c){t=!!c}}}const Ra=async r=>{const{zip:e}=await Z(()=>import("./1aaa63f0-browser.js"),[]);return new Promise(n=>e(r,{},(t,s)=>n(new Blob([s]))))},_a=r=>{const e=r.indexOf(",");return r.slice(e+1,1/0)},Ba=async r=>{if(r=await r,r instanceof Blob&&(r=await r.arrayBuffer()),r instanceof ArrayBuffer)return new Uint8Array(r);if(typeof r=="string"){const e=r.startsWith("data")?_a(r):r,n=window.atob(e);return Uint8Array.from(n,t=>t.charCodeAt(0))}};async function ja(r){const e=await Promise.all(r.map(({data:t})=>Ba(t))),n=Object.fromEntries(r.map(({name:t},s)=>[t,[e[s],{level:0,consume:!0}]]));return Ra(n)}async function Ua(r,e){const n=r.length.toString().length,t=r.map((s,i)=>{const o=i.toString().padStart(n,"0");return{name:`${e||"ss"}_${o}.png`,data:s}});return ja(t)}function za(r,e){const n=document.createElement("a");n.style.display="none",n.href=r,n.download=e,document.body.appendChild(n),n.click(),document.body.removeChild(n)}async function wt(r,e="frames"){const n=await Ua(r,e);Ce.saveAs(n,`${e}.zip`)}function Na(r){const{canvas:e,scene:n}=r;return{settings:hi,downloadFrame(s=1){const{noBackground:i,fileName:o}=this.settings,l=i&&!r.postProcessing.enabled;let a=null;const c=()=>[n.background,a]=[a,n.background];if(r.loop.state==="inactive"||s===1){l&&c(),r.render();const h=e.toDataURL();l&&c(),za(h,`${o}.png`),r.render();return}let u=0;const p=[];l&&r.addCountedEventListener("beforeRender",c);function f(){const h=e.toDataURL("image/png");p.push(h),++u===s&&(l&&r.addCountedEventListener("beforeRender",c),wt(p,o))}r.addCountedEventListener("afterRender",f,s)},getFrame(){let s;const{noBackground:i}=this.settings;if(i&&!r.postProcessing.enabled){let l=null;[n.background,l]=[l,n.background],r.render(),s=e.toDataURL("image/png"),[n.background,l]=[l,n.background],r.render()}else r.render(),s=e.toDataURL("image/png");return s},getAllFrames(s){var m,y;const i=s==null?void 0:s.animation.current.chainName;if(!i||s.animation.chain[i].duration===1/0)return;console.info("main thread locked");const l=r.loop.state;r.loop.stop(),(y=(m=s.face)==null?void 0:m.reset)==null||y.call(m),s.animation.stop();const a=[],{frameRate:c,noBackground:u}=this.settings,p=1/(c||30);let f=null,h=!0;for(u&&([n.background,f]=[f,n.background]),s.animation.addCountedEventListener("chainFinished",()=>h=!1),s.animation.play();h;){r.update(p);const v=e.toDataURL();a.push(v)}return console.info("main thread unlocked"),u&&([n.background,f]=[f,n.background]),l==="active"&&r.loop.start(),a},downloadAllFrames(s=0){const i=r.model[s],o=this.getAllFrames(i),{fileName:l}=this.settings;wt(o,l)},getAllFramesAsArrayBuffer(s){var g,P;const i=s==null?void 0:s.animation.current.chainName;if(!i||s.animation.chain[i].duration===1/0)return;console.info("main thread locked");const l=r.renderer.getContext(),a=r.loop.state;(P=(g=s.face)==null?void 0:g.reset)==null||P.call(g),r.loop.stop(),s.animation.stop();const c=[],{frameRate:u,noBackground:p}=this.settings,f=1/(u||30),{width:h,height:m}=e,v=h*m*4;let w=null,b=!0;for(p&&([n.background,w]=[w,n.background]),s.animation.addCountedEventListener("chainFinished",()=>b=!1),s.animation.play();b;){r.update(f);const x=new Uint8Array(v);l.readPixels(0,0,h,m,l.RGBA,l.UNSIGNED_BYTE,x);const A=Va(x,{width:h,height:m});c.push(A.buffer)}return console.info("main thread unlocked"),p&&([n.background,w]=[w,n.background]),a==="active"&&r.loop.start(),c}}}function Va(r,{width:e,height:n}){const t=n/2|0,s=e*4,i=new Uint8Array(e*4);for(let o=0;o<t;++o){const l=o*s,a=(n-o-1)*s;i.set(r.subarray(l,l+s)),r.copyWithin(l,a,a+s),r.set(i,a)}return r}const $a=()=>Promise.all([yi(),vi(),wi(),Si()]),Ha={directional:mn,ambient:gn,point:ft},Ga={directional:Xs,point:Ws},Xa=r=>{var a,c;const e=Ha[r];if(!e)return null;const n=mi[r],{color:t,intensity:s,...i}=n,o=new e(t,s);o.name=(c=(a=o.type)==null?void 0:a.replace)==null?void 0:c.call(a,"Light","");const l=Ga[r];return l&&(o.helper=new l(o),Object.defineProperty(o,"showHelper",{get(){return o.helper.visible},set(u){o.helper.visible=!!u,o.helper.update()}}),o.showHelper=!1),Object.defineProperty(o,"colorCode",{get(){return"#"+this.color.getHexString()},set(u){var p,f;this.color=new R(u),(f=(p=this.helper)==null?void 0:p.update)==null||f.call(p)}}),Object.entries(i).forEach(([u,p])=>{o[u].isVector3?o[u].set(...p):o[u]=p}),o};function Wa(r){const e={list:new pe,add:n=>{const t=Xa(n);if(t)return r.scene.add(t),t.helper&&(r.scene.add(t.helper),t.helper.update()),e.list.push(t),t.remove=()=>{var s,i,o,l,a;e.list.remove(t),t.helper&&((s=t.parent)==null||s.remove(t.helper),(o=(i=t.helper).dispose)==null||o.call(i)),(l=t.parent)==null||l.remove(t),(a=t.dispose)==null||a.call(t)},t}};return e}const un={"<":">","(":")","[":"]","{":"}"},Ya=r=>{let e="";const n=[],t=[];for(const s of r){if(n.length){e+=s;const i=n.at(-1);s===un[i]&&n.pop();continue}if(s==="/"){e&&t.push(e),e="";continue}e+=s,s in un&&n.push(s)}return e&&t.push(e),t},Ka=r=>Ya(r).reduce((n,t)=>{const[s,...i]=t.split("="),o=i==null?void 0:i.join("=");return s&&o&&n.push([s,o]),n},[]),Za={mat:{keys:["material","code"],valueMap:r=>r.slice(1,-1)},ol:{keys:["outline","code"],valueMap:r=>r.slice(1,-1)},ei:{keys:["face","eyeBaseIdx"]},et:{keys:["face","eyeTexture"]},mi:{keys:["face","mouthBaseIdx"]},mt:{keys:["face","mouthTexture"]},tx:{keys:["texture"]},scl:{keys:["scale"]}};async function qa(r){const e=Ka(r),n=Object.fromEntries(e),{id:t}=n,s=await this.loadDLModel(t);return await Qa(s,n),s}async function Qa(r,e){const{ani:n,...t}=e;Object.entries(t).forEach(([s,i])=>{const o=Za[s];if(!o)return;const{keys:l,valueMap:a}=o,c=(a==null?void 0:a(i))??i;Bn(r,l,c)}),n&&await r.animation.addChain(n)}const At=class{constructor(){Y(this,"userData",{ani:new pe});Y(this,"dataLoaded",!1);Y(this,"initData",async()=>{await $a(),this.dataLoaded=!0,this.dispatchEvent({type:"dataLoaded"})});Y(this,"_background","");Y(this,"model",new pe);Y(this,"loadedModel",new pe);Y(this,"loadModelFromCode",qa);Y(this,"settings",{outline:we,material:ue});Y(this,"viewport",{width:0,height:0,set(e,n){this.width=e,this.height=n}});Object.assign(this,Oe);const e=new Ys;this.scene=e,this.background=ui,this.clock=new xn;const n=$r();this.camera=n;const t=Wa(this);t.add("directional"),t.add("ambient"),this.light=t;const s=Vr();this.renderer=s,this.canvas=s.domElement,this.screenshot=Na(this),this.record=ka(this.canvas),this.controls=new qs(this.camera,this.canvas),this.postProcessing={enabled:!1,passes:new pe,composer:ln({renderer:s,scene:e,camera:n}),async addPass(i,o={}){const l=await ba(i,{...o,renderer:s,scene:e,camera:n});this.composer.addPass(l);const a=Ia(l),{passes:c}=this,u=this;return a.remove=()=>{c.remove(a),u.refresh()},c.push(a),l},async refresh(){this.composer=ln({renderer:s,scene:e,camera:n});const i=this.passes.map(({type:l,params:a})=>({type:l,params:Object.entries(a)}));this.passes.length=0;const{length:o}=i;for(let l=0;l<o;l++){const{type:a,params:c}=i[l],u=await this.addPass(a);c.forEach(([p,f])=>void(u[p]=f))}},updatePasses(i){this.passes.length=0,this.passes.splice(0,0,...i),this.refresh()}},this.stats=new vt,this.loop=Fa(this),this.loop.start(),console.info("%cDragalia Lost Model Viewer","color:yellow;background-color:black;font-size:1.5rem;text-shadow: 0 0 0.5rem white")}get background(){return this._background}set background(e){var t,s;if(this._background===e)return;this._background="loading",(s=(t=this.scene.background)==null?void 0:t.dispose)==null||s.call(t);const n=this;(async function(){n.scene.background=await Hr(e),n._background=e,e.startsWith("img:")&&n.updateBgAspectRatio()})()}get toneMapping(){var n;const{toneMapping:e}=this.renderer;return((n=Object.entries(ut).find(([,t])=>t===e))==null?void 0:n[0])??"Unknown"}set toneMapping(e){const n=ut[e]?e:"No Mapping";this.renderer.toneMapping=ut[n]}get pixelRatio(){return this.renderer.getPixelRatio()}set pixelRatio(e){this.renderer.setPixelRatio(e),this.postProcessing.composer.setPixelRatio(e)}get unusedModel(){return this.loadedModel.filter(e=>!this.model.includes(e))}async loadDLModel(e=fi){this.dataLoaded||await new Promise(o=>this.addCountedEventListener("dataLoaded",o));const n=At.getModelPath(e),t=await Rn(n);t.name=e;const s={id:e,outline:this.settings.outline,material:this.settings.material,viewer:this},i=ma(t,s);return this.loadedModel.push(i),i.addEventListener("dispose",()=>this.loadedModel.remove(i)),i}add(e){var n;(n=e.detach)==null||n.call(e),this.model.push(e),this.scene.add(e.model),e.parent=this}remove(e){this.model.remove(e),this.scene.remove(e.model)}disposeAllModels(){this.loadedModel.forEach(e=>{var n;return(n=e.dispose)==null?void 0:n.call(e)}),this.model.length=0}static getModelPath(e){return`${this.source.fbx}/${e}/${e}.fbx`}async setViewport(e,n){var o;await Ur(200);const t=e??window.innerWidth,s=n??window.innerHeight;this.viewport.set(t,s),this.renderer.setSize(t,s);const i=t/s;return this.camera.aspect=i,this.camera.updateProjectionMatrix(),(o=this.postProcessing.composer)==null||o.setSize(t,s),this.background.startsWith("img:")&&this.updateBgAspectRatio(),this}updateBgAspectRatio(){if(!this.background.startsWith("img:"))return;const{width:e,height:n}=this.viewport,t=e/n,{background:s}=this.scene,{naturalWidth:i,naturalHeight:o}=s.image,l=i/o,a=t/l,c=t>l?[1,1/a]:[a,1];s.repeat.set(...c)}update(e){var n;(n=this.animation)==null||n.update(e),this.model.forEach(t=>{var s;return(s=t.update)==null?void 0:s.call(t,e)}),this.loop.state==="inactive"&&this.render(),this.dispatchEvent({type:"timeUpdate",dt:e})}stopAll(){this.model.forEach(e=>{var n,t;return(t=(n=e.animation)==null?void 0:n.stop)==null?void 0:t.call(n)})}playAll(){this.model.forEach(e=>{var n,t;return(t=(n=e.animation)==null?void 0:n.play)==null?void 0:t.call(n)})}render(){this.dispatchEvent({type:"beforeRender"}),this.postProcessing.enabled?this.postProcessing.composer.render():this.renderer.render(this.scene,this.camera),this.dispatchEvent({type:"afterRender"})}toString(){return"Dragalia Lost Model Viewer"}dispose(){var e,n,t;this.model.forEach(s=>s.dispose()),(n=(e=this.scene.background)==null?void 0:e.dispose)==null||n.call(e),(t=this.renderer.renderLists)==null||t.dispose(),this.renderer.dispose()}};let Ie=At;Y(Ie,"source",{fbx:En,ani:Pn});var V={fullscreenEnabled:0,fullscreenElement:1,requestFullscreen:2,exitFullscreen:3,fullscreenchange:4,fullscreenerror:5,fullscreen:6},pn=["webkitFullscreenEnabled","webkitFullscreenElement","webkitRequestFullscreen","webkitExitFullscreen","webkitfullscreenchange","webkitfullscreenerror","-webkit-full-screen"],fn=["mozFullScreenEnabled","mozFullScreenElement","mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozfullscreenerror","-moz-full-screen"],hn=["msFullscreenEnabled","msFullscreenElement","msRequestFullscreen","msExitFullscreen","MSFullscreenChange","MSFullscreenError","-ms-fullscreen"],j=typeof window<"u"&&typeof window.document<"u"?window.document:{},$="fullscreenEnabled"in j&&Object.keys(V)||pn[0]in j&&pn||fn[0]in j&&fn||hn[0]in j&&hn||[],Ja={requestFullscreen:function(r){return r[$[V.requestFullscreen]]()},requestFullscreenFunction:function(r){return r[$[V.requestFullscreen]]},get exitFullscreen(){return j[$[V.exitFullscreen]].bind(j)},get fullscreenPseudoClass(){return":"+$[V.fullscreen]},addEventListener:function(r,e,n){return j.addEventListener($[V[r]],e,n)},removeEventListener:function(r,e,n){return j.removeEventListener($[V[r]],e,n)},get fullscreenEnabled(){return Boolean(j[$[V.fullscreenEnabled]])},set fullscreenEnabled(r){},get fullscreenElement(){return j[$[V.fullscreenElement]]},set fullscreenElement(r){},get onfullscreenchange(){return j[("on"+$[V.fullscreenchange]).toLowerCase()]},set onfullscreenchange(r){return j[("on"+$[V.fullscreenchange]).toLowerCase()]=r},get onfullscreenerror(){return j[("on"+$[V.fullscreenerror]).toLowerCase()]},set onfullscreenerror(r){return j[("on"+$[V.fullscreenerror]).toLowerCase()]=r}};const Ne=Ja,ne=new Ie;ne.initData();ne.setViewport();ne.userData.specialCapture={frameRate:30,duration:5,program:"rotate"};window.addEventListener("resize",()=>ne.setViewport());ne.canvas.addEventListener("dblclick",eo);window.viewer=ne;window.model=ne.model;window.getFrame=ne.screenshot.getFrame;window.downloadFrames=wt;window.saveAs=Ce.saveAs;window.THREE=wn;window.makeGif=async r=>{const{makeGif:e}=await Z(()=>import("./e220d14b-index.js"),[]);return await e(r)};function eo(){Ne.fullscreenEnabled&&(Ne.fullscreenElement?Ne.exitFullscreen():Ne.requestFullscreen(ne.canvas))}export{pe as A,Ce as F,pi as P,lo as a,Ni as b,Tt as c,Qt as d,Ua as e,ja as f,co as g,jr as h,tn as i,En as j,on as k,xr as l,Zn as n,Ka as p,ut as t,ne as v};
